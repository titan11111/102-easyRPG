<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>È≠î„ÅÆÂ±±</title>
    <style>
        /* ÂÖ®‰ΩìË®≠ÂÆö */
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: 'MS Gothic', 'Courier New', monospace; 
            margin: 0; 
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100svh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        /* „Ç≤„Éº„É†ÁîªÈù¢Ôºà‰∏äÈÉ®Ôºâ */
        #game-container { 
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        .screen { 
            display: none; 
            width: 100%; 
            max-width: 620px; 
            text-align: center; 
            padding: 10px; 
            box-sizing: border-box; 
        }

        .active { 
            display: block; 
        }

        /* „Ç¶„Ç£„É≥„Éâ„Ç¶„Éá„Ç∂„Ç§„É≥ÔºàFFÈ¢®Ôºâ */
        .ff-window {
            background: linear-gradient(180deg, #00008b 0%, #000044 100%);
            border: 3px solid #eee;
            border-radius: 8px;
            box-shadow: inset 0 0 5px #000, 0 0 10px rgba(0, 150, 255, 0.3);
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }

        .ff-window::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 5px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        /* „Ç´„Çπ„Çø„É†„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        #custom-dialog-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: calc(100% - 220px); 
            background: rgba(0,0,0,0.7); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            pointer-events: auto; 
        }

        .dialog-content {
            width: 85%; 
            max-width: 420px;
            text-align: center; 
            background: linear-gradient(180deg, #0000bb 0%, #000044 100%);
            border: 4px double #eee;
            padding: 20px;
            border-radius: 8px;
        }

        /* „Éû„ÉÉ„Éó */
        #map-grid {
            display: grid; 
            grid-template-columns: repeat(10, 8vw); 
            gap: 1px;
            max-width: 320px;
            justify-content: center; 
            margin: 10px auto;
            background-color: #222; 
            border: 2px solid #555;
        }

        @media (min-width: 400px) {
            #map-grid { 
                grid-template-columns: repeat(10, 32px); 
            }
        }

        .cell { 
            width: 100%; 
            aspect-ratio: 1/1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 18px; 
        }

        .cell.wall { background-color: #333; }
        .cell.plain { background-color: #2e8b57; }
        .cell.forest { background-color: #004d00; }
        .cell.lava { background-color: #8b0000; }
        .cell.mountain { background-color: #4b3621; }
        .cell.wasteland { background-color: #554433; } /* ÁÑ°Ê≥ï„ÅÆËçíÂú∞„ÅÆËâ≤ */
        .cell.desert { background-color: #c2b280; } /* Á†ÇÊº†„ÅÆËâ≤ */
        .cell.ruins { background-color: #444; } /* „Åã„Å§„Å¶„ÅÆÊùë„ÅÆÂ∫ä */
        .cell.hero { 
            background-color: #ffd700; 
            border-radius: 50%; 
            color: #000; 
            z-index: 5; 
        }

        /* Êà¶ÈóòÁîªÈù¢ */
        #battle-screen { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            background-color: #000; 
        }

        .enemy-area { 
            height: 35%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
        }

        .monster-sprite { 
            font-size: 160px; 
            text-shadow: 0 0 15px rgba(255,0,0,0.5); 
        }

        .monster-sprite img {
            width: 320px;
            height: 320px;
            object-fit: contain;
        }

        .battle-ui { 
            display: flex; 
            height: 240px; 
            min-height: 240px;
            gap: 5px; 
            padding: 5px; 
            flex-shrink: 0;
        }

        .command-box { 
            width: 40%; 
            text-align: left; 
            overflow-y: auto; 
        }

        .command-box li { 
            padding: 8px 5px; 
            font-size: 14px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            list-style: none; 
            position: relative;
            transition: background-color 0.2s;
        }

        .command-box li:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* FFÈ¢®„Ç´„Éº„ÇΩ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .command-cursor {
            animation: cursorBlink 1s infinite;
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .status-box { 
            width: 60%; 
            text-align: left; 
            font-size: 12px; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        #battle-log { 
            width: 95%; 
            height: 80px; 
            margin: 5px auto; 
            background: rgba(0,0,0,0.8); 
            border: 1px solid #fff; 
            padding: 5px; 
            font-size: 14px; 
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* „ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§Ë°®Á§∫ */
        .damage-number {
            position: absolute;
            font-size: 48px;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 2px 2px 0 #000, 0 0 10px #ff0000;
            pointer-events: none;
            z-index: 100;
            animation: damageFloat 1s ease-out forwards;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.5);
            }
        }

        /* „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Éí„ÉÉ„ÉàË°®Á§∫ */
        .critical-text {
            position: absolute;
            font-size: 32px;
            font-weight: bold;
            color: #ffff00;
            text-shadow: 2px 2px 0 #000, 0 0 15px #ffff00;
            pointer-events: none;
            z-index: 101;
            animation: criticalPulse 1.5s ease-out forwards;
        }

        @keyframes criticalPulse {
            0% {
                opacity: 1;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        /* ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•„Ç®„Éï„Çß„ÇØ„Éà */
        .battle-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            z-index: 200;
            animation: flashEffect 0.2s ease-out;
        }

        @keyframes flashEffect {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        /* HP„Éê„Éº */
        .hp-bar-container {
            width: 100%;
            height: 16px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #fff;
            margin: 2px 0;
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff0000 100%);
            transition: width 0.5s ease-out;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .hp-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            z-index: 10;
        }

        /* „Çπ„ÉÜ„Éº„Çø„ÇπË°å„ÅÆ„Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
        .status-row {
            margin-bottom: 4px;
            flex-shrink: 0;
        }

        .status-row-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            font-size: 11px;
        }

        /* Êïµ„ÅÆHP„Éê„Éº */
        .enemy-hp-bar {
            width: 80%;
            max-width: 300px;
            margin: 10px auto;
        }

        /* FFÈ¢®Êà¶ÈóòÈñãÂßãÊºîÂá∫ */
        .battle-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 300;
            pointer-events: none;
        }

        .battle-start-text {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
            animation: battleStartAnimation 2s ease-out forwards;
        }

        @keyframes battleStartAnimation {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            20% {
                opacity: 1;
                transform: scale(1.2);
            }
            40% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        /* FFÈ¢®ÂãùÂà©ÊºîÂá∫ */
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            pointer-events: none;
        }

        .victory-text {
            font-size: 36px;
            font-weight: bold;
            color: #ffff00;
            text-shadow: 0 0 20px #ffff00, 0 0 40px #ffff00;
            margin-bottom: 20px;
            animation: victoryPulse 1.5s ease-in-out infinite;
        }

        @keyframes victoryPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
        }

        .victory-rewards {
            font-size: 20px;
            color: #fff;
            text-align: center;
            line-height: 1.8;
        }

        /* FFÈ¢®„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫ */
        .levelup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 400;
            pointer-events: none;
        }

        .levelup-text {
            font-size: 56px;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
            animation: levelupAnimation 2.5s ease-out forwards;
        }

        @keyframes levelupAnimation {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.5);
            }
            30% {
                opacity: 1;
                transform: translateY(0) scale(1.2);
            }
            60% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
            }
        }

        .levelup-stats {
            font-size: 24px;
            color: #ffff00;
            margin-top: 20px;
            text-align: center;
            opacity: 0;
            animation: levelupStatsAnimation 2.5s ease-out forwards;
        }

        @keyframes levelupStatsAnimation {
            0%, 40% {
                opacity: 0;
                transform: translateY(20px);
            }
            60% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */
        #control-panel {
            flex-shrink: 0; 
            height: 220px; 
            width: 100%;
            background-color: #ccc;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 4px solid #999;
            user-select: none;
            touch-action: manipulation;
            padding-bottom: env(safe-area-inset-bottom);
            position: relative;
            z-index: 2000; 
        }

        .d-pad {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            gap: 2px;
        }

        .pad-btn {
            width: 55px; 
            height: 55px;
            background: #444; 
            border: none; 
            border-radius: 8px;
            color: white; 
            font-size: 24px;
            box-shadow: 0 4px #000;
            -webkit-tap-highlight-color: transparent;
        }

        .pad-btn:active { 
            transform: translateY(2px); 
            box-shadow: 0 2px #000; 
            background: #222; 
        }

        .up { grid-area: up; } 
        .down { grid-area: down; } 
        .left { grid-area: left; } 
        .right { grid-area: right; }

        .action-group { 
            display: flex; 
            gap: 15px; 
            transform: rotate(-5deg); 
        }

        .circle-btn {
            width: 70px; 
            height: 70px;
            background: #a00; 
            border: 2px solid #500; 
            border-radius: 50%;
            color: white; 
            font-size: 24px; 
            font-weight: bold;
            box-shadow: 0 4px #000;
            -webkit-tap-highlight-color: transparent;
        }

        .circle-btn:active { 
            transform: translateY(2px); 
            box-shadow: 0 2px #000; 
            background: #700; 
        }

        .btn-a { margin-top: -10px; }
        .btn-b { 
            margin-top: 20px; 
            background: #444; 
            border-color: #222; 
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen" class="screen active">
        <div class="ff-window">
            <h1>LEGEND OF INUSARUKIGI</h1>
            <p>‰ª≤Èñì„ÇíÈõÜ„ÇÅ„ÄÅÈ≠îÁéã„ÇíË®é„Å¶</p>
            <p style="color: #ff0;"></p>
            <p>„ÄêA„Éú„Çø„É≥„ÅßÈñãÂßã„Äë</p>
        </div>
    </div>

    <div id="prologue-screen" class="screen">
        <div class="ff-window">
            <div style="font-size: 160px; margin-bottom: 20px;">üï¥Ô∏è</div>
            <p id="prologue-text">„Äå„Çè„Åó„ÅØÁéãÊßò„Åò„ÇÉ„ÄÇ„Åà„Å£„Å®„ÄÅ„ÄÅ„ÄÅ„Åä‰∏ª„ÅØÔºü„Äç</p>
            <p>„ÄêA„Éú„Çø„É≥„ÅßÂêçÂâç„ÇíÊïô„Åà„Çã„Äë</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="ff-window" style="margin-bottom:5px;">
            <span id="area-title">Â†¥ÊâÄ</span>
        </div>
        <div id="map-grid"></div>
        <div class="ff-window" style="width: 100%; text-align: left;">
            <div id="st-hp">HP: 100/100</div>
            <div id="st-party">‰∏ÄË°å: ÂãáËÄÖ</div>
        </div>
        <div id="town-actions" style="display:none; margin-top: 10px;">
            <div class="ff-window">ÂÆøÂ±ã„Åå„ÅÇ„Çä„Åæ„Åô</div>
        </div>
    </div>

    <div id="battle-screen" class="screen">
        <div id="battle-log">È≠îÁâ©„Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ</div>
        <div class="enemy-area">
            <div id="monster-sprite" class="monster-sprite"></div>
            <div id="monster-name">„É¢„É≥„Çπ„Çø„Éº</div>
            <div id="enemy-hp-bar" class="enemy-hp-bar hp-bar-container" style="display:none;">
                <div id="enemy-hp-bar-fill" class="hp-bar" style="width: 100%;"></div>
                <div id="enemy-hp-bar-text" class="hp-bar-text">HP: 100/100</div>
            </div>
        </div>
        <div class="battle-ui">
            <div class="ff-window command-box">
                <ul id="command-list" style="margin:0; padding:0;">
                    <li id="cmd-attack"><span class="command-cursor">‚ñ∂</span> „Åü„Åü„Åã„ÅÜ (A)</li>
                </ul>
            </div>
            <div class="ff-window status-box" id="party-status-area"></div>
        </div>
    </div>

    <div id="ending-screen" class="screen">
        <div class="ff-window">
            <h1 id="ending-title">HAPPY ENDING</h1>
            <p id="ending-msg">‰ª≤Èñì„Å®ÂÖ±„Å´‰∏ñÁïå„ÇíÊïë„Å£„ÅüÔºÅ</p>
            <p>Âπ≥Âíå„Å™Êó•„ÄÖ„ÅåÊàª„Å£„Å¶„Åç„Åü...</p>
            <p>„ÄêA„Éú„Çø„É≥„Åß„Çø„Ç§„Éà„É´„Å∏„Äë</p>
        </div>
    </div>

    <div id="custom-dialog-overlay">
        <div class="ff-window dialog-content">
            <div id="dialog-message" style="margin-bottom: 20px; line-height: 1.5;"></div>
            <div id="dialog-footer" style="font-size: 12px; color: #ccc;">[ A„Éú„Çø„É≥„ÅßÈñâ„Åò„Çã ]</div>
        </div>
    </div>
</div>

<!-- BGMÁÆ°ÁêÜ -->
<audio id="bgm-title" loop preload="auto">
    <source src="audio/title.mp3" type="audio/mpeg">
</audio>
<audio id="bgm-prologue" loop preload="auto">
    <source src="audio/prologue.mp3" type="audio/mpeg">
</audio>
<audio id="bgm-town" loop preload="auto">
    <source src="audio/town.mp3" type="audio/mpeg">
</audio>
<audio id="bgm-field" loop preload="auto">
    <source src="audio/field.mp3" type="audio/mpeg">
</audio>
<audio id="bgm-battle" loop preload="auto">
    <source src="audio/battle.mp3" type="audio/mpeg">
</audio>
<audio id="bgm-boss" loop preload="auto">
    <source src="audio/boss.mp3" type="audio/mpeg">
</audio>
<audio id="bgm-ending" loop preload="auto">
    <source src="audio/ending.mp3" type="audio/mpeg">
</audio>

<div id="control-panel">
    <div class="d-pad">
        <button class="pad-btn up" onpointerdown="handleMove(0, -1)">‚ñ≤</button>
        <button class="pad-btn left" onpointerdown="handleMove(-1, 0)">‚óÄ</button>
        <button class="pad-btn right" onpointerdown="handleMove(1, 0)">‚ñ∂</button>
        <button class="pad-btn down" onpointerdown="handleMove(0, 1)">‚ñº</button>
    </div>

    <div class="action-group">
        <button class="circle-btn btn-b" onpointerdown="handleB()">B</button>
        <button class="circle-btn btn-a" onpointerdown="handleA()">A</button>
    </div>
</div>

<script>
/* ============================================
   ÂÆöÊï∞ÂÆöÁæ©
   ============================================ */
const TILE = {
    WALL: 1,
    ENEMY: 2,
    CASTLE: 3,
    BOSS: 4,
    ALLY_DOG: 5,
    ALLY_BIRD: 6,
    ALLY_MONKEY: 7,
    SHOP: 8,
    EMPTY: 0,
    PLAIN: 10,
    FOREST: 11,
    LAVA: 12,
    MOUNTAIN: 13,
    TREASURE_GOLD: 14,
    NPC: 15,
    DOOR: 16,
    TREASURE_KEY: 17,
    TREASURE_OPENED: 19,
    WASTELAND: 20,
    DESERT: 21,
    RUINS: 22,
    GHOST: 23,
    MOMO: 24,
    VILLAGE_ENTRANCE: 25
};

const MAP_SIZE = {
    WIDTH: 10,
    HEIGHT: 10,
    MAX_X: 9,
    MAX_Y: 9
};

const BATTLE = {
    TURN_DELAY: 800,
    ENCOUNTER_RATE: 0.15,
    DAMAGE_VARIANCE: 10,
    DEFENSE_REDUCTION: 5
};

const LEVEL_UP = {
    EXP_MULTIPLIER: 100,
    ATK_BONUS: 10,
    HP_BONUS: 20
};

const TREASURE = {
    GOLD_AMOUNT: 100
};

const IMAGE_EXTENSIONS = ['.jpg', '.png'];

/* ============================================
   Èü≥Ê•ΩÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
   ============================================ */
const BGM_VOLUME = 0.7; // 70%Èü≥Èáè
let currentBGM = null;
let audioContextUnlocked = false; // iOS SafariÂØæÂøú„Éï„É©„Ç∞

// „Ç®„É™„Ç¢Âà•BGM„Éû„ÉÉ„Éî„É≥„Ç∞
const AREA_BGM_MAP = {
    "town_inside": "bgm-town",
    "green_field": "bgm-field",
    "wasteland": "bgm-field",
    "lonely_desert": "bgm-field",
    "ruined_village": "bgm-field",
    "dark_forest": "bgm-field",
    "lava_cave": "bgm-field",
    "demon_castle": "bgm-field"
};

/**
 * iOS SafariÂØæÂøú: „É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅßÈü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ
 */
function unlockAudioContext() {
    if (audioContextUnlocked) return;
    
    try {
        // ÂÖ®„Å¶„ÅÆaudioË¶ÅÁ¥†„Çí‰∏ÄÂ∫¶ÂÜçÁîü„ÉªÂÅúÊ≠¢„Åó„Å¶„Ç¢„É≥„É≠„ÉÉ„ÇØ
        const audioElements = document.querySelectorAll('audio');
        const unlockPromises = Array.from(audioElements).map(audio => {
            const promise = audio.play();
            if (promise !== undefined) {
                return promise
                    .then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                    })
                    .catch(() => {
                        // „Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºà„Åæ„Å†„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄßÔºâ
                    });
            }
        });
        
        Promise.all(unlockPromises).then(() => {
            audioContextUnlocked = true;
            console.log('Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü');
        });
    } catch (error) {
        console.error('Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Ç¢„É≥„É≠„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
    }
}

/**
 * ÂÖ®„Å¶„ÅÆBGM„ÇíÂÅúÊ≠¢
 */
function stopAllBGM() {
    try {
        const bgmIds = [
            'bgm-title', 'bgm-prologue', 'bgm-town', 'bgm-field',
            'bgm-battle', 'bgm-boss', 'bgm-ending'
        ];
        
        bgmIds.forEach(id => {
            const audio = document.getElementById(id);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
        });
        
        currentBGM = null;
    } catch (error) {
        console.error('BGMÂÅúÊ≠¢„Ç®„É©„Éº:', error);
    }
}

/**
 * BGM„ÇíÂÜçÁîü
 */
function playBGM(bgmId) {
    try {
        // Âêå„ÅòBGM„ÅåÊó¢„Å´ÂÜçÁîü‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        if (currentBGM && currentBGM.id === bgmId && !currentBGM.paused) {
            return;
        }
        
        // ÁèæÂú®„ÅÆBGM„ÇíÂÅúÊ≠¢
        stopAllBGM();
        
        const audio = document.getElementById(bgmId);
        if (!audio) {
            console.warn(`BGMË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${bgmId}`);
            return;
        }
        
        // Èü≥Ê•Ω„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™çÔºà„Ç®„É©„Éº„Ç§„Éô„É≥„Éà„ÅßÊ§úÂá∫Ôºâ
        audio.addEventListener('error', function onError() {
            console.warn(`BGM„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${bgmId} (audio/${bgmId.replace('bgm-', '')}.mp3)`);
            audio.removeEventListener('error', onError);
        }, { once: true });
        
        // Èü≥ÈáèË®≠ÂÆö
        audio.volume = BGM_VOLUME;
        currentBGM = audio;
        
        // ÂÜçÁîü
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise
                .then(() => {
                    console.log(`BGMÂÜçÁîü: ${bgmId}`);
                })
                .catch(error => {
                    console.error(`BGMÂÜçÁîü„Ç®„É©„Éº (${bgmId}):`, error);
                    // iOS Safari„ÅÆÂ†¥Âêà„ÄÅ„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅåÂøÖË¶Å„Å™ÂèØËÉΩÊÄß„Åå„ÅÇ„Çã
                    if (!audioContextUnlocked) {
                        unlockAudioContext();
                    }
                    currentBGM = null;
                });
        }
    } catch (error) {
        console.error('BGMÂÜçÁîü„Ç®„É©„Éº:', error);
        currentBGM = null;
    }
}

/**
 * „Ç®„É™„Ç¢„Å´Âøú„Åò„ÅüBGM„ÇíÂÜçÁîü
 */
function playAreaBGM(areaId) {
    const bgmId = AREA_BGM_MAP[areaId] || 'bgm-field';
    playBGM(bgmId);
}

/* ============================================
   „Ç≤„Éº„É†„Éá„Éº„Çø
   ============================================ */
const hero = { 
    name: "ÂãáËÄÖ", 
    x: 4, 
    y: 7, 
    hp: 100, 
    maxHp: 100, 
    mp: 20, 
    maxMp: 20, 
    atk: 15, 
    mgc: 25, 
    lv: 1, 
    exp: 0, 
    gold: 0, 
    currentArea: "town_inside",
    hasKey: false 
};

const shopItems = [
    { name: "ÈäÖ„ÅÆÂâ£", price: 50, atk: 5 },
    { name: "ÈäÄ„ÅÆÂâ£", price: 150, atk: 15 },
    { name: "ÈªÑÈáë„ÅÆÂâ£", price: 500, atk: 50 }
];

const allyData = {
    5: { id: "dog", name: "Áä¨", hp: 60, maxHp: 60, atk: 12, img: "üê©", msg: "„ÉØ„É≥ÔºÅ‰∏ÄÁ∑í„Å´Êà¶„ÅÑ„Åæ„ÅôÔºÅ" },
    6: { id: "bird", name: "„Åç„Åò", hp: 40, maxHp: 40, atk: 20, img: "ü¶Ü", msg: "„Ç±„É≥„Ç±„É≥ÔºÅÁ©∫„Åã„ÇâÂä©„Åë„Åæ„ÅôÔºÅ" },
    7: { id: "monkey", name: "Áåø", hp: 80, maxHp: 80, atk: 10, img: "üêí", msg: "„Ç¶„Ç≠„ÉÉÔºÅ„Éú„ÇØ„ÇÇË°å„Åè„ÇàÔºÅ" }
};

let party = [hero];
let trueKingMet = false; 
let prologueStep = 0;

const monsterTable = {
    "green_field": [
        { name: "„Éü„ÉÅÁîüÂëΩ‰Ωì", hp: 30, atk: 8, exp: 40, gold: 20, img: "üëΩ" }, 
        { name: "Â§ßËõá", hp: 45, atk: 12, exp: 50, gold: 30, img: "üêç" }
    ],
    "wasteland": [
        { name: "„Å™„Çâ„ÅöËÄÖ", hp: 60, atk: 15, exp: 60, gold: 40, img: "ü§†" },
        { name: "„Éè„Ç≤„Çø„Ç´", hp: 50, atk: 18, exp: 70, gold: 30, img: "ü¶Ö" }
    ],
    "lonely_desert": [
        { name: "„Çµ„ÇΩ„É™", hp: 70, atk: 22, exp: 90, gold: 50, img: "ü¶Ç" },
        { name: "„Éü„Ç§„É©", hp: 90, atk: 18, exp: 110, gold: 60, img: "üßü" }
    ],
    "ruined_village": [
        { name: "„ÅÜ„Çâ„Åø", hp: 100, atk: 25, exp: 150, gold: 80, img: "üëª" }
    ],
    "dark_forest": [
        { name: "„Ç™„Ç™„Ç™„Éà„Ç≥", hp: 80, atk: 20, exp: 120, gold: 60, img: "üßå" }, 
        { name: "ÈùôÈõªÊ∞ó", hp: 60, atk: 25, exp: 100, gold: 80, img: "üßû" }
    ],
    "lava_cave": [
        { name: "„Éâ„ÇØ„É¢„É™", hp: 150, atk: 35, exp: 250, gold: 120, img: "ü¶á" }, 
        { name: "„Éí„Éà„ÇØ„Ç§„Ç∏„É£„ÉÉ„ÇØ", hp: 180, atk: 30, exp: 300, gold: 150, img: "üéÉ" }
    ],
    "demon_castle": [
        { name: "Ê∞¥Á•û", hp: 400, atk: 55, exp: 600, gold: 300, img: "üêâ" }, 
        { name: "„É¥„Ç£„É©„É≥", hp: 500, atk: 60, exp: 800, gold: 500, img: "ü¶π" }
    ]
};

const worldMaps = {
    "town_inside": {
        name: "„Éù„ÉÅ„ÅÆÊùë",
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,17,1],
            [1,0,8,0,0,0,0,0,0,1],
            [1,0,0,0,15,0,0,0,0,1],
            [1,1,1,1,0,0,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,15,0,1],
            [1,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,0,0,1,1,1,1],
            [1,1,1,1,0,0,1,1,1,1]
        ],
        exits: { bottom: "green_field" },
        npcs: [
            { x: 4, y: 3, img: "üßë", msg: "„Åì„ÅÆÊùë„Å´„ÄéÂè§„ÅÑÈçµ„Äè„ÅåÈö†„Åï„Çå„Å¶„ÅÑ„Çã„Çâ„Åó„ÅÑ„Åû„ÄÇ" },
            { x: 7, y: 6, img: "üëß", msg: "È≠îÁéã„ÅÆÂüé„ÅÆÈñÄ„Å´„ÅØ„ÄÅÈçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã„ÅÆ„ÄÇ" }
        ]
    },
    "green_field": { 
        name: "Âßã„Åæ„Çä„ÅÆÂπ≥Âéü", 
        data: [
            [1,1,1,1,0,0,1,1,1,1],
            [1,0,10,10,10,10,10,10,10,0],
            [1,10,10,10,5,10,10,10,10,1],
            [1,2,1,1,10,1,1,1,10,1],
            [1,10,10,10,10,10,10,10,14,1],
            [1,1,1,10,3,10,10,1,1,1],
            [1,10,10,10,1,1,10,10,10,1],
            [1,10,1,1,1,10,10,1,10,1],
            [1,10,10,10,10,10,10,10,10,1],
            [1,1,1,1,0,0,1,1,1,1] 
        ], 
        exits: { right: "dark_forest", top: "town_inside", bottom: "wasteland" } 
    },
    "wasteland": {
        name: "ÁÑ°Ê≥ï„ÅÆËçíÂú∞",
        data: [
            [1,1,1,1,0,0,1,1,1,1],
            [1,20,20,20,20,20,2,20,20,1],
            [1,20,1,1,20,1,1,20,20,1],
            [1,20,20,20,20,20,20,20,20,0], 
            [1,20,1,1,1,20,20,1,1,1],
            [1,2,20,20,20,20,20,20,20,1],
            [1,20,1,1,20,1,1,1,20,1],
            [1,20,20,20,20,20,20,20,20,1],
            [1,20,20,2,20,20,20,2,20,1],
            [1,1,1,1,1,1,1,1,1,1]
        ],
        exits: { top: "green_field", right: "lonely_desert" }
    },
    "lonely_desert": {
            name: "ÂØÇ„Åó„ÅÑÁ†ÇÊº†",
            data: [
                [1,1,1,1,0,0,1,1,1,1],
                [1,21,21,21,21,21,21,21,21,1],
                [1,21,1,1,1,1,1,1,21,1],
                [0,21,1,21,21,21,21,21,21,1],
                [1,21,1,21,25,21,21,21,21,1], // 25: „Åã„Å§„Å¶„ÅÆÊùë„ÅÆÂÖ•„ÇäÂè£ (üèöÔ∏è)
                [1,21,1,21,21,21,21,1,21,1],
                [1,21,1,1,1,1,1,1,21,1],
                [1,21,21,2,21,21,21,21,21,1],
                [1,21,21,21,21,2,21,21,21,1],
                [1,1,1,1,1,1,1,1,1,1]
            ],
            exits: { left: "wasteland", top: "dark_forest" }
        },
    "ruined_village": {
        name: "„Åã„Å§„Å¶„ÅÆÊùë",
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [1,22,22,22,22,22,22,22,22,1],
            [1,22,1,1,22,22,1,1,22,1],
            [1,22,1,23,22,22,24,1,22,1], // 23:„ÅäÂåñ„Åë, 24:Ê°É‰ªô‰∫∫
            [1,22,22,22,22,22,22,22,22,1],
            [1,22,22,1,1,1,1,22,22,1],
            [1,22,22,22,22,22,22,22,22,1],
            [1,1,22,22,22,22,22,22,1,1],
            [1,1,1,1,0,0,1,1,1,1], // ‰∏ã„Åã„ÇâÁ†ÇÊº†„Å´Êàª„Çã
            [1,1,1,1,1,1,1,1,1,1]
        ],
        exits: { bottom: "lonely_desert" }
    },
    "dark_forest": { 
        name: "Ëø∑„ÅÑ„ÅÆÊ£Æ", 
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [0,11,2,11,11,6,11,11,2,1],
            [1,11,1,1,11,1,11,1,11,1],
            [1,11,1,11,11,2,11,1,11,1],
            [1,2,1,11,7,1,11,1,11,1],
            [1,11,11,11,11,11,11,11,11,0],
            [1,1,1,1,1,1,11,1,1,1],
            [1,11,11,11,2,11,11,1,11,1],
            [1,11,1,1,1,1,1,1,11,1],
            [1,1,1,1,0,0,1,1,1,1] 
        ], 
        exits: { left: "green_field", right: "lava_cave", bottom: "lonely_desert" } 
    },
    "lava_cave": { 
        name: "ÁÅ´„ÅÆÊ¥ûÁ™ü", 
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [0,12,12,12,12,12,12,2,12,1],
            [1,1,1,1,12,1,1,1,12,1],
            [1,2,12,12,12,1,8,12,12,1],
            [1,12,1,1,1,1,12,1,1,1],
            [1,12,12,12,12,2,12,12,12,0],
            [1,1,1,1,1,1,1,1,12,1],
            [1,2,12,12,12,12,12,2,12,1],
            [1,12,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1]
        ], 
        exits: { left: "dark_forest", right: "demon_castle" } 
    },
    "demon_castle": { 
        name: "Ê∞¥„ÅÆÂ±±", 
        data: [
            [1,1,1,1,4,1,1,1,1,1],
            [1,13,13,13,16,13,13,13,13,1],
            [1,13,1,1,1,1,1,1,13,1],
            [1,2,1,13,13,13,13,1,2,1],
            [1,13,13,13,1,1,13,13,13,1],
            [0,13,1,2,1,1,2,1,13,1],
            [1,13,1,13,13,13,13,1,13,1],
            [1,13,13,13,1,1,13,13,13,1],
            [1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1]
        ], 
        exits: { left: "lava_cave" } 
    }
};

/* ============================================
   Áä∂ÊÖãÁÆ°ÁêÜ
   ============================================ */
let currentEnemy = null;
let canAttack = true;
let isBattle = false;
let isBattleEnding = false;

/* ============================================
   „Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÂá¶ÁêÜ
   ============================================ */
function handleMove(dx, dy) {
    // iOS SafariÂØæÂøú: ÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅßÈü≥Â£∞„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ
    if (!audioContextUnlocked) {
        unlockAudioContext();
    }
    
    if (isBattle) return;
    if (document.getElementById('custom-dialog-overlay').style.display === 'flex') return;
    if (document.getElementById('prologue-screen').classList.contains('active')) return;
    moveHero(dx, dy);
}

function handleA() {
    // iOS SafariÂØæÂøú: ÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅßÈü≥Â£∞„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ
    if (!audioContextUnlocked) {
        unlockAudioContext();
    }
    
    const dialogOverlay = document.getElementById('custom-dialog-overlay');
    const startScreen = document.getElementById('start-screen');
    const prologueScreen = document.getElementById('prologue-screen');
    const endingScreen = document.getElementById('ending-screen');
    const townActions = document.getElementById('town-actions');

    // „ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
    if (dialogOverlay.style.display === 'flex') {
        closeCustomDialog();
        return;
    }

    // „Çø„Ç§„Éà„É´ÁîªÈù¢
    if (startScreen.classList.contains('active')) {
        // „Çø„Ç§„Éà„É´BGM„ÇíÂÅúÊ≠¢„Åó„Å¶„Åã„Çâ„Éó„É≠„É≠„Éº„Ç∞„Å∏
        stopAllBGM();
        showScreen('prologue-screen');
        playBGM('bgm-prologue');
        return;
    }

    // „Éó„É≠„É≠„Éº„Ç∞ÁîªÈù¢
    if (prologueScreen.classList.contains('active')) {
        startPrologue();
        return;
    }

    // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÁîªÈù¢
    if (endingScreen.classList.contains('active')) {
        // BGM„ÇíÂÅúÊ≠¢„Åó„Å¶„Åã„Çâ„É™„É≠„Éº„Éâ
        stopAllBGM();
        location.reload();
        return;
    }

    // Êà¶Èóò‰∏≠
    if (isBattle) {
        if (isBattleEnding) {
            confirmBattleResult();
        } else if (canAttack) {
            heroTurn('attack');
        }
        return;
    }

    // ÂÆøÂ±ã„Ç¢„ÇØ„Ç∑„Éß„É≥
    if (townActions.style.display === 'block') {
        rest();
        return;
    }
}

function handleB() {
    console.log("B„Éú„Çø„É≥");
}

/* ============================================
   „Éû„ÉÉ„ÉóÊèèÁîª
   ============================================ */
function drawMap() {
    const mapInfo = worldMaps[hero.currentArea];
    document.getElementById('area-title').innerText = mapInfo.name;
    const grid = document.getElementById('map-grid');
    grid.innerHTML = '';

    mapInfo.data.forEach((row, y) => {
        row.forEach((type, x) => {
            const cell = document.createElement('div');
            cell.className = 'cell';

            // Âú∞ÂΩ¢„Çø„Ç§„Éó„ÅÆ„ÇØ„É©„ÇπË®≠ÂÆö
            if (type === TILE.WALL) cell.classList.add('wall');
            if (type === TILE.PLAIN) cell.classList.add('plain');
            if (type === TILE.FOREST) cell.classList.add('forest');
            if (type === TILE.LAVA) cell.classList.add('lava');
            if (type === TILE.MOUNTAIN) cell.classList.add('mountain');
            if (type === TILE.WASTELAND) cell.classList.add('wasteland');
            if (type === TILE.DESERT) cell.classList.add('desert');
            if (type === TILE.RUINS) cell.classList.add('ruins');

            // „Éí„Éº„É≠„Éº„ÅÆ‰ΩçÁΩÆ
            if (x === hero.x && y === hero.y) {
                cell.innerText = 'üö∂';
                cell.classList.add('hero');
            } else if (type >= TILE.ALLY_DOG && type <= TILE.ALLY_MONKEY) {
                // ‰ª≤Èñì„Ç≠„É£„É©„ÇØ„Çø„Éº
                cell.innerText = allyData[type].img;
            } else {
                // „Åù„ÅÆ‰ªñ„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                const icons = { 
                    [TILE.ENEMY]: 'üëæ', 
                    [TILE.CASTLE]: 'üè∞', 
                    [TILE.BOSS]: 'üëπ', 
                    [TILE.SHOP]: 'üè¨', 
                    [TILE.TREASURE_GOLD]: 'üéÅ', 
                    [TILE.NPC]: 'üë≥', 
                    [TILE.DOOR]: 'üö™', 
                    [TILE.TREASURE_KEY]: 'üéÅ', 
                    [TILE.TREASURE_OPENED]: 'üóÉÔ∏è',
                    [TILE.GHOST]: 'üëª', 
                    [TILE.MOMO]: 'üçë', 
                    [TILE.VILLAGE_ENTRANCE]: 'üèöÔ∏è'
                }; 
                if (mapInfo.npcs) {
                    const npc = mapInfo.npcs.find(n => n.x === x && n.y === y);
                    if (npc) {
                        cell.innerText = npc.img;
                        grid.appendChild(cell);
                        return;
                    }
                }
                cell.innerText = icons[type] || '';
            }
            grid.appendChild(cell);
        });
    });
}

/* ============================================
   ÁßªÂãï„Éª„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
   ============================================ */
function moveHero(dx, dy) {
    let nx = hero.x + dx;
    let ny = hero.y + dy;
    const map = worldMaps[hero.currentArea];

    // „Ç®„É™„Ç¢ÁßªÂãïÂá¶ÁêÜ
    if (nx < 0 && map.exits.left) { 
        hero.currentArea = map.exits.left; 
        hero.x = MAP_SIZE.MAX_X; 
        return afterMove(); 
    }
    if (nx > MAP_SIZE.MAX_X && map.exits.right) { 
        hero.currentArea = map.exits.right; 
        hero.x = 0; 
        return afterMove(); 
    }
    if (ny > MAP_SIZE.MAX_Y && map.exits.bottom) {
        hero.currentArea = map.exits.bottom;
        hero.x = (hero.currentArea === "lonely_desert") ? 4 : nx;
        hero.y = 0; 
        return afterMove();
    }
    if (ny < 0 && map.exits.top) {
        hero.currentArea = map.exits.top;
        hero.x = nx; 
        hero.y = MAP_SIZE.MAX_Y;
        return afterMove();
    }

    // „Éû„ÉÉ„ÉóÂÜÖ„ÅÆÁßªÂãï
    if (nx >= 0 && nx <= MAP_SIZE.MAX_X && ny >= 0 && ny <= MAP_SIZE.MAX_Y) {
        const tile = map.data[ny][nx];
        
        // Â£Å„ÉÅ„Çß„ÉÉ„ÇØ
        if (tile === TILE.WALL) return; 

        // Êââ„ÅÆÂá¶ÁêÜ
        if (tile === TILE.DOOR) {
            if (hero.hasKey) {
                showAlert("Èçµ„Çí‰Ωø„Å£„Å¶Êââ„ÇíÈñã„Åë„ÅüÔºÅ");
                map.data[ny][nx] = TILE.EMPTY; 
            } else {
                showAlert("Èçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Å¶ÈÄ≤„ÇÅ„Å™„ÅÑ„ÄÇ");
                return;
            }
        }

        hero.x = nx; 
        hero.y = ny;

        // „Çø„Ç§„É´„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        handleTileEvent(tile, nx, ny, map);
        
        // „É©„É≥„ÉÄ„É†„Ç®„É≥„Ç´„Ç¶„É≥„Éà
        if (isEncounterableTile(tile) && Math.random() < BATTLE.ENCOUNTER_RATE) {
            startBattle();
        }
    }
    afterMove();
}

/**
 * „Çø„Ç§„É´„Ç§„Éô„É≥„Éà„ÇíÂá¶ÁêÜ
 */
function handleTileEvent(tile, x, y, map) {
    switch (tile) {
        case TILE.VILLAGE_ENTRANCE:
            hero.currentArea = "ruined_village";
            hero.x = 4;
            hero.y = 7;
            showAlert("„Åã„Å§„Å¶„ÅÆÊùë„Å´ÂÖ•„Å£„Åü...");
            break;
        case TILE.CASTLE:
            if (trueKingMet) {
                startNiseousamaBattle();
            } else {
                showAlert("‰ªä„ÅØÂøô„Åó„ÅÑ„ÄÇÂ∑ù„ÇíË™ø„Åπ„Å¶„Åç„Å¶„Åè„Çå„ÄÇ");
                hero.y++; 
            }
            break;
        case TILE.ALLY_DOG:
        case TILE.ALLY_BIRD:
        case TILE.ALLY_MONKEY:
            addAlly(tile);
            break;
        case TILE.ENEMY:
            startBattle();
            break;
        case TILE.TREASURE_GOLD:
            hero.gold += TREASURE.GOLD_AMOUNT;
            showAlert("ÂÆùÁÆ±„ÇíÈñã„Åë„ÅüÔºÅ\n100„Ç¥„Éº„É´„ÉâÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ");
            map.data[y][x] = TILE.TREASURE_OPENED;
            break;
        case TILE.TREASURE_KEY:
            hero.hasKey = true;
            showAlert("ÂÆùÁÆ±„Åã„Çâ„ÄéÂè§„ÅÑÈçµ„Äè„ÇíË¶ã„Å§„Åë„ÅüÔºÅ");
            map.data[y][x] = TILE.TREASURE_OPENED;
            break;
        case TILE.NPC:
            const npc = map.npcs?.find(n => n.x === x && n.y === y);
            if (npc) showAlert(npc.msg);
            break;
        case TILE.SHOP:
            showShop(); 
            break;
        case TILE.BOSS:
            triggerBossEvent();
            break;
        case TILE.GHOST:
            showAlert("„Äå„Åì„Åì„ÅØ„Åã„Å§„Å¶„ÅÆÊùë‚Ä¶„Åô„Åπ„Å¶„ÅØ„ÅÇ„ÅÑ„Å§„Å´Â•™„Çè„Çå„Åü‚Ä¶„Äç");
            break;
        case TILE.MOMO:
            startMomoBattle();
            break;
    }
}

/**
 * „Ç®„É≥„Ç´„Ç¶„É≥„ÉàÂèØËÉΩ„Å™„Çø„Ç§„É´„ÅãÂà§ÂÆö
 */
function isEncounterableTile(tile) {
    return tile === TILE.PLAIN || 
           tile === TILE.FOREST || 
           tile === TILE.WASTELAND || 
           tile === TILE.DESERT || 
           tile === TILE.RUINS;
}

function afterMove() {
    updateNPCs();
    drawMap(); 
    updateStatus();
    // „Ç®„É™„Ç¢Â§âÊõ¥ÊôÇ„Å´BGM„ÇíÂàá„ÇäÊõø„Åà
    playAreaBGM(hero.currentArea);
}

function updateNPCs() {
    const map = worldMaps[hero.currentArea];
    if (map.npcs) {
        map.npcs.forEach(npc => {
            const directions = [[0,1], [0,-1], [1,0], [-1,0]];
            const dir = directions[Math.floor(Math.random() * directions.length)];
            const tx = npc.x + dir[0];
            const ty = npc.y + dir[1];
            if (tx >= 0 && tx <= MAP_SIZE.MAX_X && 
                ty >= 0 && ty <= MAP_SIZE.MAX_Y && 
                map.data[ty][tx] === TILE.EMPTY && 
                !(tx === hero.x && ty === hero.y)) {
                npc.x = tx;
                npc.y = ty;
            }
        });
    }
}

function addAlly(type) {
    const ally = allyData[type];
    if (!party.find(m => m.name === ally.name)) {
        party.push({ ...ally });
        worldMaps[hero.currentArea].data[hero.y][hero.x] = TILE.EMPTY; 
        drawMap();
        updateStatus();
        showAlert(`${ally.name}:„Äå${ally.msg}„Äç\n\n${ally.name}„Åå‰ª≤Èñì„Å´Âä†„Çè„Å£„ÅüÔºÅ`);
    }
}

/* ============================================
   „Ç∑„Éä„É™„Ç™„Ç§„Éô„É≥„Éà
   ============================================ */
function startPrologue() {
    const textElem = document.getElementById('prologue-text');
    if (prologueStep === 0) {
        let name = prompt("„Åä‰∏ª„ÅÆÂêçÂâç„ÇíÊïô„Åà„Å¶„Åè„ÇåÔºà„Ç´„Çø„Ç´„Éä4ÊñáÂ≠ó‰ª•ÂÜÖÔºâ", "„É¶„Ç¶„Ç∑„É£");
        if (!name) name = "„É¶„Ç¶„Ç∑„É£";
        hero.name = name.substring(0, 4);
        textElem.innerText = `ÁéãÊßòÔºö„Äå„Åù„ÅÜ„Åò„ÇÉ„Å£„Åü„ÄÅ${hero.name}„Çà„ÄÇÈ†º„Åø„Åå„ÅÇ„Çã„ÄÇ„Äç`;
        prologueStep++;
    } else if (prologueStep === 1) {
        textElem.innerText = "ÁéãÊßòÔºö„ÄåÊúÄËøë„ÄÅË°ó„ÅÆÂ∑ù„ÅÆÊµÅ„Çå„ÅåÊÇ™„Åè„Å™„Å£„Å¶„Åä„Çã„ÅÆ„Åò„ÇÉ„ÄÇ„Äç";
        prologueStep++;
    } else if (prologueStep === 2) {
        textElem.innerText = "ÁéãÊßòÔºö„Äå‰ΩïËÄÖ„Åã„ÅåÂ∑ù‰∏ä„ÅßÊÇ™„Åï„Çí„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åã„ÇÇ„Åó„Çå„Çì„ÄÇ„Äç";
        prologueStep++;
    } else if (prologueStep === 3) {
        textElem.innerText = `ÁéãÊßòÔºö„Äå${hero.name}„Çà„ÄÅÂ∑ù‰∏ä„ÇíË™ø„Åπ„Å¶„Åç„Å¶„ÅØ„Åè„Çå„Åæ„ÅÑ„ÅãÔºü„Äç`;
        prologueStep++;
    } else {
        showScreen('main-screen');
        drawMap();
        updateStatus();
        playAreaBGM(hero.currentArea);
        showAlert("ÁéãÊßò„Å´È†º„Åæ„Çå„ÄÅÂÜíÈô∫„ÅåÂßã„Åæ„Å£„ÅüÔºÅ");
    }
}

function triggerBossEvent() {
    const choice = confirm("Ê∞¥Ê∫ê„Å´È≠îÁéã„Åå„ÅÑ„Åæ„Åô„ÄÇÊà¶„ÅÑ„Åæ„Åô„ÅãÔºü");
    if (choice) {
        startBossBattle();
    } else {
        const joinChoice = confirm("ÁßÅ„ÅåÂÖÉÁéãÊßò„Å†„ÄÇÊ∞¥Ê∫ê„ÅÆÂ≤©„Çí„Å©„Åã„Åô„ÅÆ„ÇíÊâã‰ºù„Å£„Å¶„Åè„Çå„Çì„ÅãÔºü");
        if (joinChoice) {
            trueKingMet = true;
            showAlert("„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÇË°ó„ÅÆÁéã„ÅØÂÅΩÁâ©„Åò„ÇÉ„ÄÇÊá≤„Çâ„Åó„ÇÅ„Å¶„Åè„Çå„ÄÇ");
        } else {
            startBossBattle();
        }
    }
}

function startNiseousamaBattle() {
    showAlert("„Ç™„Ç¶„Çµ„Éû„Éã„Ç¢:„Äå„Éê„É¨„Åü„Åã„ÄÇÈÇ™È≠îËÄÖ„ÅØÊ∂à„Åà„ÇàÔºÅÔºÅÔºÅÔºÅ„Äç");
    isBattle = true;
    isBattleEnding = false;
    currentEnemy = { 
        name: "„Ç™„Ç¶„Çµ„Éû„Éã„Ç¢", 
        hp: 1200, 
        atk: 70, 
        exp: 0, 
        gold: 0, 
        img: 'images/niseousama.png' // "images/"
    };
    initBattle();
}

function startMomoBattle() {
    showAlert("Ê°É‰ªô‰∫∫:„Äå„Çè„Åó„ÅÆ„Åä‰æõ„ÇíÂãùÊâã„Å´‰ª≤Èñì„Å´„Åó„Åü„ÅÆ„ÅØ„ÅäÂâç„ÅãÔºü\nË®±„Åï„ÇìÔºÅ„Äç");
    isBattle = true;
    isBattleEnding = false;
    currentEnemy = { 
        name: "Ê°É‰ªô‰∫∫", 
        hp: 800, 
        atk: 45, 
        exp: 1000, 
        gold: 500, 
        img: 'images/momosennin.png' // "images/"
    };
    initBattle();
}

/* ============================================
   Êà¶Èóò„Ç∑„Çπ„ÉÜ„É†
   ============================================ */
function startBattle() {
    isBattle = true;
    isBattleEnding = false;
    const areaMonsters = monsterTable[hero.currentArea] || monsterTable["green_field"];
    const randomIndex = Math.floor(Math.random() * areaMonsters.length);
    currentEnemy = { ...areaMonsters[randomIndex] };
    initBattle();
}

function startBossBattle() {
    isBattle = true;
    isBattleEnding = false;
    currentEnemy = { name: "È≠îÁéã", hp: 1000, atk: 60, exp: 0, gold: 0, img: "üëπ" };
    initBattle();
}

function initBattle() {
    canAttack = true;
    document.getElementById('monster-name').innerText = currentEnemy.name;
    
    // Êïµ„ÅÆÊúÄÂ§ßHP„Çí‰øùÂ≠òÔºàHP„Éê„ÉºË°®Á§∫Áî®Ôºâ
    if (!currentEnemy.maxHp) {
        currentEnemy.maxHp = currentEnemy.hp;
    }
    
    // ÁîªÂÉè„ÅãÁµµÊñáÂ≠ó„Åã„ÇíÂà§ÂÆö
    const isImage = IMAGE_EXTENSIONS.some(ext => currentEnemy.img.endsWith(ext));
    if (isImage) {
        document.getElementById('monster-sprite').innerHTML = `<img src="${currentEnemy.img}" alt="${currentEnemy.name}">`;
    } else {
        document.getElementById('monster-sprite').innerHTML = currentEnemy.img;
    }

    // Êà¶Èóò„É≠„Ç∞„Çí„ÇØ„É™„Ç¢
    const battleLog = document.getElementById('battle-log');
    battleLog.innerHTML = '';
    
    updateBattleStatus();
    updateEnemyHPBar();
    showScreen('battle-screen');
    
    // FFÈ¢®Êà¶ÈóòÈñãÂßãÊºîÂá∫
    showBattleStartAnimation();
    
    // „Éú„ÇπÊà¶„ÅãÈÄöÂ∏∏Êà¶Èóò„Åã„ÅßBGM„ÇíÂàá„ÇäÊõø„Åà
    if (currentEnemy.name === "È≠îÁéã" || currentEnemy.name === "„Ç™„Ç¶„Çµ„Éû„Éã„Ç¢" || currentEnemy.name === "Ê°É‰ªô‰∫∫") {
        playBGM('bgm-boss');
    } else {
        playBGM('bgm-battle');
    }
}

/**
 * FFÈ¢®Êà¶ÈóòÈñãÂßãÊºîÂá∫
 */
function showBattleStartAnimation() {
    const overlay = document.createElement('div');
    overlay.className = 'battle-start-overlay';
    const text = document.createElement('div');
    text.className = 'battle-start-text';
    text.innerText = 'Êà¶ÈóòÈñãÂßãÔºÅ';
    overlay.appendChild(text);
    document.body.appendChild(overlay);
    
    setTimeout(() => {
        addBattleLog(`${currentEnemy.name}„Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`);
        overlay.remove();
    }, 2000);
}

function updateBattleStatus() {
    const area = document.getElementById('party-status-area');
    area.innerHTML = '<div style="border-bottom: 1px solid #fff; margin-bottom: 3px; padding-bottom: 2px; font-weight: bold; font-size: 11px;">NAME HP</div>';
    
    // ÊúÄÂ§ß4‰∫∫„ÅÆÊû†„ÇíÁ¢∫‰øùÔºà„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº + Á©∫„ÅçÊû†Ôºâ
    const maxSlots = 4;
    for (let i = 0; i < maxSlots; i++) {
        if (i < party.length) {
            // „Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„Åå„ÅÑ„ÇãÂ†¥Âêà
            const m = party[i];
            const displayHp = m.hp > 0 ? m.hp : 0;
            const hpPercent = (displayHp / m.maxHp) * 100;
            area.innerHTML += `
                <div class="status-row">
                    <div class="status-row-header">
                        <span>${m.name}</span>
                        <span>${displayHp}/${m.maxHp}</span>
                    </div>
                    <div class="hp-bar-container" style="width: 100%;">
                        <div class="hp-bar" style="width: ${hpPercent}%;"></div>
                        <div class="hp-bar-text">${displayHp}/${m.maxHp}</div>
                    </div>
                </div>`;
        } else {
            // Á©∫„ÅçÊû†ÔºàËñÑ„ÅèË°®Á§∫Ôºâ
            area.innerHTML += `
                <div class="status-row" style="opacity: 0.3;">
                    <div class="status-row-header">
                        <span>---</span>
                        <span>-/-</span>
                    </div>
                    <div class="hp-bar-container" style="width: 100%;">
                        <div class="hp-bar" style="width: 0%;"></div>
                        <div class="hp-bar-text">-/-</div>
                    </div>
                </div>`;
        }
    }
}

/**
 * Êïµ„ÅÆHP„Éê„Éº„ÇíÊõ¥Êñ∞
 */
function updateEnemyHPBar() {
    const hpBar = document.getElementById('enemy-hp-bar');
    const hpBarFill = document.getElementById('enemy-hp-bar-fill');
    const hpBarText = document.getElementById('enemy-hp-bar-text');
    
    if (!currentEnemy || !currentEnemy.maxHp) return;
    
    const hpPercent = Math.max(0, (currentEnemy.hp / currentEnemy.maxHp) * 100);
    hpBar.style.display = 'block';
    hpBarFill.style.width = `${hpPercent}%`;
    hpBarText.innerText = `HP: ${Math.max(0, currentEnemy.hp)}/${currentEnemy.maxHp}`;
}

/**
 * Êà¶Èóò„É≠„Ç∞„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†Ôºà„Çπ„ÇØ„É≠„Éº„É´ÂØæÂøúÔºâ
 */
function addBattleLog(message) {
    const battleLog = document.getElementById('battle-log');
    const timestamp = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    battleLog.innerHTML += `<div>${message}</div>`;
    // ÊúÄÊñ∞„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Å´„Çπ„ÇØ„É≠„Éº„É´
    battleLog.scrollTop = battleLog.scrollHeight;
}

function heroTurn(action) {
    if (!canAttack) return;
    canAttack = false;
    performAttack(hero);

    if (currentEnemy.hp > 0) {
        setTimeout(partyTurn, BATTLE.TURN_DELAY);
    } else {
        setTimeout(winBattle, BATTLE.TURN_DELAY);
    }
}

function partyTurn() {
    let index = 1;
    function nextAlly() {
        if (currentEnemy.hp <= 0) { winBattle(); return; }
        if (index < party.length) {
            const member = party[index];
            if (member.hp > 0) { 
                performAttack(member); 
                index++; 
                setTimeout(nextAlly, BATTLE.TURN_DELAY); 
        } else {
                index++; 
                nextAlly(); 
            }
        } else {
            if (currentEnemy.hp > 0) {
                setTimeout(enemyTurn, BATTLE.TURN_DELAY);
            } else {
                winBattle();
            }
        }
    }
    nextAlly();
}

function performAttack(attacker) {
    // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´Âà§ÂÆöÔºà10%„ÅÆÁ¢∫ÁéáÔºâ
    const isCritical = Math.random() < 0.1;
    let dmg = attacker.atk + Math.floor(Math.random() * BATTLE.DAMAGE_VARIANCE);
    
    if (isCritical) {
        dmg = Math.floor(dmg * 1.5); // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÅØ1.5ÂÄç
    }
    
    currentEnemy.hp = Math.max(0, currentEnemy.hp - dmg);
    
    // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•„Ç®„Éï„Çß„ÇØ„Éà
    showBattleFlash();
    
    // „ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§Ë°®Á§∫
    showDamageNumber(dmg, isCritical);
    
    // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„É°„ÉÉ„Çª„Éº„Ç∏
    if (isCritical) {
        showCriticalText();
        addBattleLog(`${attacker.name}„ÅÆ‰ºöÂøÉ„ÅÆ‰∏ÄÊíÉÔºÅ${currentEnemy.name}„Å´${dmg}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
    } else {
        addBattleLog(`${attacker.name}„ÅÆÊîªÊíÉÔºÅ${currentEnemy.name}„Å´${dmg}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
    }
    
    updateBattleStatus();
    updateEnemyHPBar();
}

/**
 * „ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§„ÇíË°®Á§∫
 */
function showDamageNumber(damage, isCritical) {
    const enemyArea = document.querySelector('.enemy-area');
    const damageElement = document.createElement('div');
    damageElement.className = 'damage-number';
    damageElement.innerText = `-${damage}`;
    
    if (isCritical) {
        damageElement.style.color = '#ffff00';
        damageElement.style.fontSize = '56px';
        damageElement.style.textShadow = '2px 2px 0 #000, 0 0 15px #ffff00';
    }
    
    // Êïµ„ÅÆ‰∏≠ÂøÉ‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ
    const rect = enemyArea.getBoundingClientRect();
    damageElement.style.left = `${rect.left + rect.width / 2 - 50}px`;
    damageElement.style.top = `${rect.top + rect.height / 2 - 40}px`;
    
    document.body.appendChild(damageElement);
    
    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´ÂâäÈô§
    setTimeout(() => {
        damageElement.remove();
    }, 1000);
}

/**
 * „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÉÜ„Ç≠„Çπ„Éà„ÇíË°®Á§∫
 */
function showCriticalText() {
    const enemyArea = document.querySelector('.enemy-area');
    const criticalElement = document.createElement('div');
    criticalElement.className = 'critical-text';
    criticalElement.innerText = '‰ºöÂøÉ„ÅÆ‰∏ÄÊíÉÔºÅ';
    
    const rect = enemyArea.getBoundingClientRect();
    criticalElement.style.left = `${rect.left + rect.width / 2 - 100}px`;
    criticalElement.style.top = `${rect.top + 20}px`;
    
    document.body.appendChild(criticalElement);
    
    setTimeout(() => {
        criticalElement.remove();
    }, 1500);
}

/**
 * ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•„Ç®„Éï„Çß„ÇØ„Éà
 */
function showBattleFlash() {
    const flash = document.createElement('div');
    flash.className = 'battle-flash';
    document.body.appendChild(flash);
    
    setTimeout(() => {
        flash.remove();
    }, 200);
}

function enemyTurn() {
    const aliveMembers = party.filter(m => m.hp > 0);
    if (aliveMembers.length === 0) return; 
    const target = aliveMembers[Math.floor(Math.random() * aliveMembers.length)];
    const dmg = Math.max(1, currentEnemy.atk - BATTLE.DEFENSE_REDUCTION);
    target.hp = Math.max(0, target.hp - dmg);
    
    // Êïµ„ÅÆÊîªÊíÉÊôÇ„ÇÇ„Éï„É©„ÉÉ„Ç∑„É•„Å®„ÉÄ„É°„Éº„Ç∏Ë°®Á§∫ÔºàÂë≥Êñπ„ÅÆ‰ΩçÁΩÆ„Å´Ë°®Á§∫Ôºâ
    showBattleFlash();
    showDamageNumberOnParty(dmg, target);
    
    addBattleLog(`${currentEnemy.name}„ÅÆÊîªÊíÉÔºÅ${target.name}„ÅØ${dmg}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
    updateBattleStatus();

    if (hero.hp <= 0) { 
        addBattleLog("ÂãáËÄÖ„ÅåÂäõÂ∞Ω„Åç„Åü...");
        showAlert("ÂãáËÄÖ„ÅåÂäõÂ∞Ω„Åç„Åü..."); 
        setTimeout(() => location.reload(), 2000); 
    } else { 
        setTimeout(() => { 
            canAttack = true; 
            addBattleLog("„Ç≥„Éû„É≥„Éâ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ (A„Éú„Çø„É≥)");
        }, BATTLE.TURN_DELAY); 
    }
}

/**
 * Âë≥Êñπ„Å∏„ÅÆ„ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§„ÇíË°®Á§∫
 */
function showDamageNumberOnParty(damage, target) {
    const statusArea = document.getElementById('party-status-area');
    const damageElement = document.createElement('div');
    damageElement.className = 'damage-number';
    damageElement.innerText = `-${damage}`;
    damageElement.style.color = '#ff6666'; // Âë≥Êñπ„Å∏„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÅØÂ∞ë„ÅóËñÑ„ÇÅ„ÅÆËµ§
    
    // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç®„É™„Ç¢ÂÜÖ„ÅÆË©≤ÂΩì„É°„É≥„Éê„Éº„ÅÆ‰ΩçÁΩÆ„Å´Ë°®Á§∫
    const rect = statusArea.getBoundingClientRect();
    damageElement.style.left = `${rect.right - 100}px`;
    damageElement.style.top = `${rect.top + 30}px`; // ÊúÄÂàù„ÅÆ„É°„É≥„Éê„Éº„ÅÆ‰ΩçÁΩÆ
    
    document.body.appendChild(damageElement);
    
    setTimeout(() => {
        damageElement.remove();
    }, 1000);
}

function winBattle() {
    isBattleEnding = true;
    addBattleLog(`${currentEnemy.name}„ÇíÂÄí„Åó„ÅüÔºÅ`);
    
    // FFÈ¢®ÂãùÂà©ÊºîÂá∫
    showVictoryAnimation();
}

/**
 * FFÈ¢®ÂãùÂà©ÊºîÂá∫
 */
function showVictoryAnimation() {
    const overlay = document.createElement('div');
    overlay.className = 'victory-overlay';
    
    const victoryText = document.createElement('div');
    victoryText.className = 'victory-text';
    victoryText.innerText = 'ÂãùÂà©ÔºÅ';
    overlay.appendChild(victoryText);
    
    const rewards = document.createElement('div');
    rewards.className = 'victory-rewards';
    let rewardText = `ÁµåÈ®ìÂÄ§: ${currentEnemy.exp}`;
    if (currentEnemy.gold > 0) {
        rewardText += `\n„Ç¥„Éº„É´„Éâ: ${currentEnemy.gold}G`;
    }
    rewards.innerText = rewardText;
    overlay.appendChild(rewards);
    
    document.body.appendChild(overlay);
    
    setTimeout(() => {
        overlay.remove();
        addBattleLog('(A„Éú„Çø„É≥„ÅßÈÄ≤„ÇÄ)');
    }, 2500);
}

function confirmBattleResult() {
    isBattle = false;
    isBattleEnding = false;
    if (currentEnemy.name === "È≠îÁéã") {
        document.getElementById('ending-msg').innerText = `„Åì„ÅÜ„Åó„Å¶Ë°ó„ÅÆÂ∑ù„ÅØÁ©è„ÇÑ„Åã„Å™ÊµÅ„Çå„ÇíÂèñ„ÇäÊàª„Åó„Åü„ÄÇ`;
        showScreen('ending-screen');
        playBGM('bgm-ending');
    } else if (currentEnemy.name === "„Ç™„Ç¶„Çµ„Éû„Éã„Ç¢") {
        document.getElementById('ending-title').innerText = "TRUE ENDING";
        document.getElementById('ending-msg').innerText = `ÂÅΩ„ÅÆÁéã„ÇíËøΩ„ÅÑÂá∫„Åó„ÄÅÊú¨Áâ©„ÅÆÁéã„ÅåË°ó„Å´Êàª„Å£„ÅüÔºÅ`;
        showScreen('ending-screen');
        playBGM('bgm-ending');
    } else {
        if (currentEnemy.name === "Ê°É‰ªô‰∫∫") {
            showAlert("Ê°É‰ªô‰∫∫:„ÄåË¶ã‰∫ã„Å†„ÄÇ„Åä‰∏ª„Å´Áúü„ÅÆÂäõ„ÇíÊéà„Åë„Çà„ÅÜ„ÄÇ„Äç\nÂãáËÄÖ„ÅÆÊîªÊíÉÂäõ„ÅåÂ§ßÂπÖ„Å´„Ç¢„ÉÉ„Éó„Åó„ÅüÔºÅ");
            hero.atk += 30;
            worldMaps["ruined_village"].data[3][6] = TILE.RUINS; // Ê°É‰ªô‰∫∫„ÇíÂ∫ä„Å´Êàª„Åô
        }
        hero.exp += currentEnemy.exp;
        hero.gold += (currentEnemy.gold || 0); 
        const map = worldMaps[hero.currentArea];
        if (map.data[hero.y][hero.x] === TILE.ENEMY) {
            map.data[hero.y][hero.x] = TILE.RUINS;
        }
        showScreen('main-screen'); 
        drawMap(); 
        updateStatus();
        playAreaBGM(hero.currentArea);
        checkLevelUp();
    }
}

/* ============================================
   „Ç∑„Çπ„ÉÜ„É†Èñ¢Êï∞
   ============================================ */
function checkLevelUp() { 
    const requiredExp = hero.lv * LEVEL_UP.EXP_MULTIPLIER;
    if (hero.exp >= requiredExp) { 
        const oldLv = hero.lv;
        hero.lv++; 
        hero.atk += LEVEL_UP.ATK_BONUS; 
        hero.maxHp += LEVEL_UP.HP_BONUS; 
        hero.hp = hero.maxHp; 
        
        // FFÈ¢®„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫
        showLevelUpAnimation(oldLv, hero.lv);
    } 
}

/**
 * FFÈ¢®„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫
 */
function showLevelUpAnimation(oldLv, newLv) {
    const overlay = document.createElement('div');
    overlay.className = 'levelup-overlay';
    
    const levelupText = document.createElement('div');
    levelupText.className = 'levelup-text';
    levelupText.innerText = `„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ`;
    overlay.appendChild(levelupText);
    
    const stats = document.createElement('div');
    stats.className = 'levelup-stats';
    stats.innerHTML = `LV ${oldLv} ‚Üí LV ${newLv}<br>ÊîªÊíÉÂäõ +${LEVEL_UP.ATK_BONUS}<br>ÊúÄÂ§ßHP +${LEVEL_UP.HP_BONUS}`;
    overlay.appendChild(stats);
    
    document.body.appendChild(overlay);
    
    setTimeout(() => {
        overlay.remove();
        showAlert(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ LV ${newLv}\nÊîªÊíÉÂäõ„Å®HP„Åå‰∏ä„Åå„Å£„ÅüÔºÅ`);
    }, 2500);
}

function rest() { 
    hero.hp = hero.maxHp; 
    hero.mp = hero.maxMp; 
    updateStatus(); 
    showAlert("ÂÆøÂ±ã„Åß‰ºë„Çì„ÅßÂÖ®Âø´„Åó„ÅüÔºÅ"); 
}

function updateStatus() { 
    document.getElementById('st-hp').innerText = `HP: ${hero.hp}/${hero.maxHp} | Gold: ${hero.gold}G | Èçµ: ${hero.hasKey ? 'ÊåÅ' : 'ÁÑ°'}`; 
    document.getElementById('st-party').innerText = `‰∏ÄË°å: [${hero.name}] ` + party.slice(1).map(m => m.name).join(", "); 
}

function showScreen(id) { 
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
}

function showAlert(text) { 
    document.getElementById('dialog-message').innerText = text; 
    document.getElementById('custom-dialog-overlay').style.display = 'flex'; 
}

function closeCustomDialog() { 
    document.getElementById('custom-dialog-overlay').style.display = 'none'; 
}

function showShop() {
    let msg = "Ê≠¶Âô®Â±ã (Áï™Âè∑ÂÖ•Âäõ):\n";
    shopItems.forEach((item, index) => { msg += `${index}: ${item.name} (${item.price}G)\n`; });
    const choice = prompt(msg);
    if (choice !== null && shopItems[choice]) {
        const item = shopItems[choice];
        if (hero.gold >= item.price) { 
            hero.gold -= item.price; 
            hero.atk += item.atk; 
            showAlert(`${item.name}„ÇíË≥ºÂÖ•ÔºÅ`); 
            updateStatus(); 
        } else { showAlert("„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ"); }
    }
}

document.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
window.addEventListener('load', function() {
    // „Çø„Ç§„Éà„É´BGM„ÅØÊ∫ñÂÇô„ÅÆ„ÅøÔºà„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂæå„Å´ÂÜçÁîüÔºâ
    // ÂÆüÈöõ„ÅÆÂÜçÁîü„ÅØ handleA() „Åß„É¶„Éº„Ç∂„Éº„ÅåA„Éú„Çø„É≥„ÇíÊäº„Åó„ÅüÊôÇ„Å´Ë°å„ÅÜ
    console.log('„Ç≤„Éº„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
});
</script>
</body>
</html>
