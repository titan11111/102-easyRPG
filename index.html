<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é­”ã®å±±ï¼ˆæ‹¡å¼µç‰ˆï¼šæ¡ƒä»™äººã®è©¦ç·´ï¼‰</title>
    <style>
        /* å…¨ä½“è¨­å®š */
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: 'MS Gothic', 'Courier New', monospace; 
            margin: 0; 
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100svh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆä¸Šéƒ¨ï¼‰ */
        #game-container { 
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        .screen { 
            display: none; 
            width: 100%; 
            max-width: 620px; 
            text-align: center; 
            padding: 10px; 
            box-sizing: border-box; 
        }

        .active { 
            display: block; 
        }

        /* ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .ff-window {
            background: linear-gradient(180deg, #00008b 0%, #000044 100%);
            border: 3px solid #eee;
            border-radius: 8px;
            box-shadow: inset 0 0 5px #000;
            padding: 10px;
            box-sizing: border-box;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
        #custom-dialog-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: calc(100% - 220px); 
            background: rgba(0,0,0,0.7); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            pointer-events: auto; 
        }

        .dialog-content {
            width: 85%; 
            max-width: 420px;
            text-align: center; 
            background: linear-gradient(180deg, #0000bb 0%, #000044 100%);
            border: 4px double #eee;
            padding: 20px;
            border-radius: 8px;
        }

        /* ãƒãƒƒãƒ— */
        #map-grid {
            display: grid; 
            grid-template-columns: repeat(10, 8vw); 
            gap: 1px;
            max-width: 320px;
            justify-content: center; 
            margin: 10px auto;
            background-color: #222; 
            border: 2px solid #555;
        }

        @media (min-width: 400px) {
            #map-grid { 
                grid-template-columns: repeat(10, 32px); 
            }
        }

        .cell { 
            width: 100%; 
            aspect-ratio: 1/1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 18px; 
        }

        .cell.wall { background-color: #333; }
        .cell.plain { background-color: #2e8b57; }
        .cell.forest { background-color: #004d00; }
        .cell.lava { background-color: #8b0000; }
        .cell.mountain { background-color: #4b3621; }
        .cell.wasteland { background-color: #554433; } /* ç„¡æ³•ã®è’åœ°ã®è‰² */
        .cell.desert { background-color: #c2b280; } /* ç ‚æ¼ ã®è‰² */
        .cell.ruins { background-color: #444; } /* ã‹ã¤ã¦ã®æ‘ã®åºŠ */
        .cell.hero { 
            background-color: #ffd700; 
            border-radius: 50%; 
            color: #000; 
            z-index: 5; 
        }

        /* æˆ¦é—˜ç”»é¢ */
        #battle-screen { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            background-color: #000; 
        }

        .enemy-area { 
            height: 40%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
        }

        .monster-sprite { 
            font-size: 80px; 
            text-shadow: 0 0 15px rgba(255,0,0,0.5); 
        }

        .monster-sprite img {
            width: 160px;
            height: 160px;
            object-fit: contain;
        }

        .battle-ui { 
            display: flex; 
            height: 120px; 
            gap: 5px; 
            padding: 5px; 
        }

        .command-box { 
            width: 40%; 
            text-align: left; 
            overflow-y: auto; 
        }

        .command-box li { 
            padding: 8px 5px; 
            font-size: 14px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            list-style: none; 
        }

        .status-box { 
            width: 60%; 
            text-align: left; 
            font-size: 14px; 
            overflow-y: auto; 
        }

        #battle-log { 
            width: 95%; 
            height: 50px; 
            margin: 5px auto; 
            background: rgba(0,0,0,0.8); 
            border: 1px solid #fff; 
            padding: 5px; 
            font-size: 14px; 
            overflow: hidden; 
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        #control-panel {
            flex-shrink: 0; 
            height: 220px; 
            width: 100%;
            background-color: #ccc;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 4px solid #999;
            user-select: none;
            touch-action: manipulation;
            padding-bottom: env(safe-area-inset-bottom);
            position: relative;
            z-index: 2000; 
        }

        .d-pad {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            gap: 2px;
        }

        .pad-btn {
            width: 55px; 
            height: 55px;
            background: #444; 
            border: none; 
            border-radius: 8px;
            color: white; 
            font-size: 24px;
            box-shadow: 0 4px #000;
            -webkit-tap-highlight-color: transparent;
        }

        .pad-btn:active { 
            transform: translateY(2px); 
            box-shadow: 0 2px #000; 
            background: #222; 
        }

        .up { grid-area: up; } 
        .down { grid-area: down; } 
        .left { grid-area: left; } 
        .right { grid-area: right; }

        .action-group { 
            display: flex; 
            gap: 15px; 
            transform: rotate(-5deg); 
        }

        .circle-btn {
            width: 70px; 
            height: 70px;
            background: #a00; 
            border: 2px solid #500; 
            border-radius: 50%;
            color: white; 
            font-size: 24px; 
            font-weight: bold;
            box-shadow: 0 4px #000;
            -webkit-tap-highlight-color: transparent;
        }

        .circle-btn:active { 
            transform: translateY(2px); 
            box-shadow: 0 2px #000; 
            background: #700; 
        }

        .btn-a { margin-top: -10px; }
        .btn-b { 
            margin-top: 20px; 
            background: #444; 
            border-color: #222; 
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen" class="screen active">
        <div class="ff-window">
            <h1>LEGEND OF INUSARUKIGI</h1>
            <p>ä»²é–“ã‚’é›†ã‚ã€é­”ç‹ã‚’è¨ã¦</p>
            <p style="color: #ff0;"></p>
            <p>ã€Aãƒœã‚¿ãƒ³ã§é–‹å§‹ã€‘</p>
        </div>
    </div>

    <div id="prologue-screen" class="screen">
        <div class="ff-window">
            <div style="font-size: 160px; margin-bottom: 20px;">ğŸ•´ï¸</div>
            <p id="prologue-text">ã€Œã‚ã—ã¯ç‹æ§˜ã˜ã‚ƒã€‚ãˆã£ã¨ã€ã€ã€ãŠä¸»ã¯ï¼Ÿã€</p>
            <p>ã€Aãƒœã‚¿ãƒ³ã§åå‰ã‚’æ•™ãˆã‚‹ã€‘</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="ff-window" style="margin-bottom:5px;">
            <span id="area-title">å ´æ‰€</span>
        </div>
        <div id="map-grid"></div>
        <div class="ff-window" style="width: 100%; text-align: left;">
            <div id="st-hp">HP: 100/100</div>
            <div id="st-party">ä¸€è¡Œ: å‹‡è€…</div>
        </div>
        <div id="town-actions" style="display:none; margin-top: 10px;">
            <div class="ff-window">å®¿å±‹ãŒã‚ã‚Šã¾ã™</div>
        </div>
    </div>

    <div id="battle-screen" class="screen">
        <div id="battle-log">é­”ç‰©ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼</div>
        <div class="enemy-area">
            <div id="monster-sprite" class="monster-sprite"></div>
            <div id="monster-name">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</div>
        </div>
        <div class="battle-ui">
            <div class="ff-window command-box">
                <ul id="command-list" style="margin:0; padding:0;">
                    <li id="cmd-attack">â–¶ ãŸãŸã‹ã† (A)</li>
                </ul>
            </div>
            <div class="ff-window status-box" id="party-status-area"></div>
        </div>
    </div>

    <div id="ending-screen" class="screen">
        <div class="ff-window">
            <h1 id="ending-title">HAPPY ENDING</h1>
            <p id="ending-msg">ä»²é–“ã¨å…±ã«ä¸–ç•Œã‚’æ•‘ã£ãŸï¼</p>
            <p>å¹³å’Œãªæ—¥ã€…ãŒæˆ»ã£ã¦ããŸ...</p>
            <p>ã€Aãƒœã‚¿ãƒ³ã§ã‚¿ã‚¤ãƒˆãƒ«ã¸ã€‘</p>
        </div>
    </div>

    <div id="custom-dialog-overlay">
        <div class="ff-window dialog-content">
            <div id="dialog-message" style="margin-bottom: 20px; line-height: 1.5;"></div>
            <div id="dialog-footer" style="font-size: 12px; color: #ccc;">[ Aãƒœã‚¿ãƒ³ã§é–‰ã˜ã‚‹ ]</div>
        </div>
    </div>
</div>

<div id="control-panel">
    <div class="d-pad">
        <button class="pad-btn up" onpointerdown="handleMove(0, -1)">â–²</button>
        <button class="pad-btn left" onpointerdown="handleMove(-1, 0)">â—€</button>
        <button class="pad-btn right" onpointerdown="handleMove(1, 0)">â–¶</button>
        <button class="pad-btn down" onpointerdown="handleMove(0, 1)">â–¼</button>
    </div>

    <div class="action-group">
        <button class="circle-btn btn-b" onpointerdown="handleB()">B</button>
        <button class="circle-btn btn-a" onpointerdown="handleA()">A</button>
    </div>
</div>

<script>
/* --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ --- */
const hero = { 
    name: "å‹‡è€…", 
    x: 4, 
    y: 7, 
    hp: 100, 
    maxHp: 100, 
    mp: 20, 
    maxMp: 20, 
    atk: 15, 
    mgc: 25, 
    lv: 1, 
    exp: 0, 
    gold: 0, 
    currentArea: "town_inside",
    hasKey: false 
};

const shopItems = [
    { name: "éŠ…ã®å‰£", price: 50, atk: 5 },
    { name: "éŠ€ã®å‰£", price: 150, atk: 15 },
    { name: "é»„é‡‘ã®å‰£", price: 500, atk: 50 }
];

const allyData = {
    5: { id: "dog", name: "çŠ¬", hp: 60, maxHp: 60, atk: 12, img: "ğŸ©", msg: "ãƒ¯ãƒ³ï¼ä¸€ç·’ã«æˆ¦ã„ã¾ã™ï¼" },
    6: { id: "bird", name: "ãã˜", hp: 40, maxHp: 40, atk: 20, img: "ğŸ¦†", msg: "ã‚±ãƒ³ã‚±ãƒ³ï¼ç©ºã‹ã‚‰åŠ©ã‘ã¾ã™ï¼" },
    7: { id: "monkey", name: "çŒ¿", hp: 80, maxHp: 80, atk: 10, img: "ğŸ’", msg: "ã‚¦ã‚­ãƒƒï¼ãƒœã‚¯ã‚‚è¡Œãã‚ˆï¼" }
};

let party = [hero];
let trueKingMet = false; 
let prologueStep = 0;

const monsterTable = {
    "green_field": [
        { name: "ãƒŸãƒç”Ÿå‘½ä½“", hp: 30, atk: 8, exp: 40, gold: 20, img: "ğŸ‘½" }, 
        { name: "å¤§è›‡", hp: 45, atk: 12, exp: 50, gold: 30, img: "ğŸ" }
    ],
    "wasteland": [
        { name: "ãªã‚‰ãšè€…", hp: 60, atk: 15, exp: 60, gold: 40, img: "ğŸ¤ " },
        { name: "ãƒã‚²ã‚¿ã‚«", hp: 50, atk: 18, exp: 70, gold: 30, img: "ğŸ¦…" }
    ],
    "lonely_desert": [
        { name: "ã‚µã‚½ãƒª", hp: 70, atk: 22, exp: 90, gold: 50, img: "ğŸ¦‚" },
        { name: "ãƒŸã‚¤ãƒ©", hp: 90, atk: 18, exp: 110, gold: 60, img: "ğŸ§Ÿ" }
    ],
    "ruined_village": [
        { name: "ã†ã‚‰ã¿", hp: 100, atk: 25, exp: 150, gold: 80, img: "ğŸ‘»" }
    ],
    "dark_forest": [
        { name: "ã‚ªã‚ªã‚ªãƒˆã‚³", hp: 80, atk: 20, exp: 120, gold: 60, img: "ğŸ§Œ" }, 
        { name: "é™é›»æ°—", hp: 60, atk: 25, exp: 100, gold: 80, img: "ğŸ§" }
    ],
    "lava_cave": [
        { name: "ãƒ‰ã‚¯ãƒ¢ãƒª", hp: 150, atk: 35, exp: 250, gold: 120, img: "ğŸ¦‡" }, 
        { name: "ãƒ’ãƒˆã‚¯ã‚¤ã‚¸ãƒ£ãƒƒã‚¯", hp: 180, atk: 30, exp: 300, gold: 150, img: "ğŸƒ" }
    ],
    "demon_castle": [
        { name: "æ°´ç¥", hp: 400, atk: 55, exp: 600, gold: 300, img: "ğŸ‰" }, 
        { name: "ãƒ´ã‚£ãƒ©ãƒ³", hp: 500, atk: 60, exp: 800, gold: 500, img: "ğŸ¦¹" }
    ]
};

const worldMaps = {
    "town_inside": {
        name: "ãƒãƒã®æ‘",
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,17,1],
            [1,0,8,0,0,0,0,0,0,1],
            [1,0,0,0,15,0,0,0,0,1],
            [1,1,1,1,0,0,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,15,0,1],
            [1,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,0,0,1,1,1,1],
            [1,1,1,1,0,0,1,1,1,1]
        ],
        exits: { bottom: "green_field" },
        npcs: [
            { x: 4, y: 3, img: "ğŸ‘³", msg: "ã“ã®æ‘ã®åŒ—æ±ã«ã€å¤ã„éµã€ãŒéš ã•ã‚Œã¦ã„ã‚‹ã‚‰ã—ã„ãã€‚" },
            { x: 7, y: 6, img: "ğŸ‘§", msg: "é­”ç‹ã®åŸã®é–€ã«ã¯ã€éµãŒã‹ã‹ã£ã¦ã„ã‚‹ã®ã€‚" }
        ]
    },
    "green_field": { 
        name: "å§‹ã¾ã‚Šã®å¹³åŸ", 
        data: [
            [1,1,1,1,0,0,1,1,1,1],
            [1,0,10,10,10,10,10,10,10,0],
            [1,10,10,10,5,10,10,10,10,1],
            [1,2,1,1,10,1,1,1,10,1],
            [1,10,10,10,10,10,10,10,14,1],
            [1,1,1,10,3,10,10,1,1,1],
            [1,10,10,10,1,1,10,10,10,1],
            [1,10,1,1,1,10,10,1,10,1],
            [1,10,10,10,10,10,10,10,10,1],
            [1,1,1,1,0,0,1,1,1,1] 
        ], 
        exits: { right: "dark_forest", top: "town_inside", bottom: "wasteland" } 
    },
    "wasteland": {
        name: "ç„¡æ³•ã®è’åœ°",
        data: [
            [1,1,1,1,0,0,1,1,1,1],
            [1,20,20,20,20,20,2,20,20,1],
            [1,20,1,1,20,1,1,20,20,1],
            [1,20,20,20,20,20,20,20,20,0], 
            [1,20,1,1,1,20,20,1,1,1],
            [1,2,20,20,20,20,20,20,20,1],
            [1,20,1,1,20,1,1,1,20,1],
            [1,20,20,20,20,20,20,20,20,1],
            [1,20,20,2,20,20,20,2,20,1],
            [1,1,1,1,1,1,1,1,1,1]
        ],
        exits: { top: "green_field", right: "lonely_desert" }
    },
    "lonely_desert": {
        name: "å¯‚ã—ã„ç ‚æ¼ ",
        data: [
            [1,1,1,1,0,0,1,1,1,1], 
            [1,21,21,21,21,21,21,21,21,1],
            [1,21,1,1,1,1,1,1,21,1],
            [0,21,1,21,21,21,21,1,21,1], 
            [1,21,1,21,25,21,21,1,21,1], // 25: ã‹ã¤ã¦ã®æ‘ã®å…¥ã‚Šå£ (ğŸšï¸)
            [1,21,1,21,21,21,21,1,21,1],
            [1,21,1,1,1,1,1,1,21,1],
            [1,21,21,2,21,21,21,21,21,1],
            [1,21,21,21,21,2,21,21,21,1],
            [1,1,1,1,1,1,1,1,1,1]
        ],
        exits: { left: "wasteland", top: "dark_forest" }
    },
    "ruined_village": {
        name: "ã‹ã¤ã¦ã®æ‘",
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [1,22,22,22,22,22,22,22,22,1],
            [1,22,1,1,22,22,1,1,22,1],
            [1,22,1,23,22,22,24,1,22,1], // 23:ãŠåŒ–ã‘, 24:æ¡ƒä»™äºº
            [1,22,22,22,22,22,22,22,22,1],
            [1,22,22,1,1,1,1,22,22,1],
            [1,22,22,22,22,22,22,22,22,1],
            [1,1,22,22,22,22,22,22,1,1],
            [1,1,1,1,0,0,1,1,1,1], // ä¸‹ã‹ã‚‰ç ‚æ¼ ã«æˆ»ã‚‹
            [1,1,1,1,1,1,1,1,1,1]
        ],
        exits: { bottom: "lonely_desert" }
    },
    "dark_forest": { 
        name: "è¿·ã„ã®æ£®", 
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [0,11,2,11,11,6,11,11,2,1],
            [1,11,1,1,11,1,11,1,11,1],
            [1,11,1,11,11,2,11,1,11,1],
            [1,2,1,11,7,1,11,1,11,1],
            [1,11,11,11,11,11,11,11,11,0],
            [1,1,1,1,1,1,11,1,1,1],
            [1,11,11,11,2,11,11,1,11,1],
            [1,11,1,1,1,1,1,1,11,1],
            [1,1,1,1,0,0,1,1,1,1] 
        ], 
        exits: { left: "green_field", right: "lava_cave", bottom: "lonely_desert" } 
    },
    "lava_cave": { 
        name: "ç«ã®æ´çªŸ", 
        data: [
            [1,1,1,1,1,1,1,1,1,1],
            [0,12,12,12,12,12,12,2,12,1],
            [1,1,1,1,12,1,1,1,12,1],
            [1,2,12,12,12,1,8,12,12,1],
            [1,12,1,1,1,1,12,1,1,1],
            [1,12,12,12,12,2,12,12,12,0],
            [1,1,1,1,1,1,1,1,12,1],
            [1,2,12,12,12,12,12,2,12,1],
            [1,12,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1]
        ], 
        exits: { left: "dark_forest", right: "demon_castle" } 
    },
    "demon_castle": { 
        name: "æ°´ã®å±±", 
        data: [
            [1,1,1,1,4,1,1,1,1,1],
            [1,13,13,13,16,13,13,13,13,1],
            [1,13,1,1,1,1,1,1,13,1],
            [1,2,1,13,13,13,13,1,2,1],
            [1,13,13,13,1,1,13,13,13,1],
            [0,13,1,2,1,1,2,1,13,1],
            [1,13,1,13,13,13,13,1,13,1],
            [1,13,13,13,1,1,13,13,13,1],
            [1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1]
        ], 
        exits: { left: "lava_cave" } 
    }
};

/* --- çŠ¶æ…‹ç®¡ç† --- */
let currentEnemy = null;
let canAttack = true;
let isBattle = false;
let isBattleEnding = false;

/* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å‡¦ç† --- */
function handleMove(dx, dy) {
    if (isBattle) return;
    if (document.getElementById('custom-dialog-overlay').style.display === 'flex') return;
    if (document.getElementById('prologue-screen').classList.contains('active')) return;
    moveHero(dx, dy);
}

function handleA() {
    const startScreen = document.getElementById('start-screen');
    const prologueScreen = document.getElementById('prologue-screen');
    const dialogOverlay = document.getElementById('custom-dialog-overlay');
    const townActions = document.getElementById('town-actions');
    const endingScreen = document.getElementById('ending-screen');

    if (dialogOverlay.style.display === 'flex') {
        closeCustomDialog();
        return;
    }

    if (startScreen.classList.contains('active')) {
        showScreen('prologue-screen');
        return;
    }

    if (prologueScreen.classList.contains('active')) {
        startPrologue();
        return;
    }

    if (endingScreen.classList.contains('active')) {
        location.reload();
        return;
    }

    if (isBattle) {
        if (isBattleEnding) {
            confirmBattleResult();
        } else if (canAttack) {
            heroTurn('attack');
        }
        return;
    }

    if (townActions.style.display === 'block') {
        rest();
        return;
    }
}

function handleB() {
    console.log("Bãƒœã‚¿ãƒ³");
}

/* --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ --- */
function drawMap() {
    const mapInfo = worldMaps[hero.currentArea];
    document.getElementById('area-title').innerText = mapInfo.name;
    const grid = document.getElementById('map-grid');
    grid.innerHTML = '';

    mapInfo.data.forEach((row, y) => {
        row.forEach((type, x) => {
            const cell = document.createElement('div');
            cell.className = 'cell';

            if (type === 1) cell.classList.add('wall');
            if (type === 10) cell.classList.add('plain');
            if (type === 11) cell.classList.add('forest');
            if (type === 12) cell.classList.add('lava');
            if (type === 13) cell.classList.add('mountain');
            if (type === 20) cell.classList.add('wasteland');
            if (type === 21) cell.classList.add('desert');
            if (type === 22) cell.classList.add('ruins');

            if (x === hero.x && y === hero.y) {
                cell.innerText = 'ğŸš¶';
                cell.classList.add('hero');
            } else if (type >= 5 && type <= 7) {
                cell.innerText = allyData[type].img;
            } else {
                const icons = { 
                    2: 'ğŸ‘¾', 3: 'ğŸ°', 4: 'ğŸ‘¹', 8: 'ğŸ¬', 
                    14: 'ğŸ', 15: 'ğŸ‘³', 16: 'ğŸšª', 17: 'ğŸ', 19: 'ğŸ—ƒï¸',
                    23: 'ğŸ‘»', 24: 'ğŸ‘', 25: 'ğŸšï¸'
                }; 
                if (mapInfo.npcs) {
                    const npc = mapInfo.npcs.find(n => n.x === x && n.y === y);
                    if (npc) {
                        cell.innerText = npc.img;
                        grid.appendChild(cell);
                        return;
                    }
                }
                cell.innerText = icons[type] || '';
            }
            grid.appendChild(cell);
        });
    });
}

function moveHero(dx, dy) {
    let nx = hero.x + dx;
    let ny = hero.y + dy;
    const map = worldMaps[hero.currentArea];

    // ã‚¨ãƒªã‚¢ç§»å‹•å‡¦ç†
    if (nx < 0 && map.exits.left) { 
        hero.currentArea = map.exits.left; 
        hero.x = 9; 
        return afterMove(); 
    }
    if (nx > 9 && map.exits.right) { 
        hero.currentArea = map.exits.right; 
        hero.x = 0; 
        return afterMove(); 
    }
    if (ny > 9 && map.exits.bottom) {
        hero.currentArea = map.exits.bottom;
        hero.x = (hero.currentArea === "lonely_desert") ? 4 : nx;
        hero.y = 0; 
        return afterMove();
    }
    if (ny < 0 && map.exits.top) {
        hero.currentArea = map.exits.top;
        hero.x = nx; 
        hero.y = 9;
        return afterMove();
    }

    if (nx >= 0 && nx <= 9 && ny >= 0 && ny <= 9) {
        const tile = map.data[ny][nx];
        if (tile === 1) return; 

        if (tile === 16) {
            if (hero.hasKey) {
                showAlert("éµã‚’ä½¿ã£ã¦æ‰‰ã‚’é–‹ã‘ãŸï¼");
                map.data[ny][nx] = 0; 
            } else {
                showAlert("éµãŒã‹ã‹ã£ã¦ã„ã¦é€²ã‚ãªã„ã€‚");
                return;
            }
        }

        hero.x = nx; 
        hero.y = ny;

        if (tile === 25) { // æ‘ã¸ã®å…¥ã‚Šå£
            hero.currentArea = "ruined_village";
            hero.x = 4;
            hero.y = 7;
            showAlert("ã‹ã¤ã¦ã®æ‘ã«å…¥ã£ãŸ...");
            return afterMove();
        }

        if (tile === 3) {
            if (trueKingMet) {
                startNiseousamaBattle();
                return;
            } else {
                showAlert("ä»Šã¯å¿™ã—ã„ã€‚å·ã‚’èª¿ã¹ã¦ãã¦ãã‚Œã€‚");
                hero.y++; 
            }
        }
        if (tile >= 5 && tile <= 7) addAlly(tile);
        if (tile === 2) startBattle();
        if (tile === 14) {
            hero.gold += 100;
            showAlert("å®ç®±ã‚’é–‹ã‘ãŸï¼\n100ã‚´ãƒ¼ãƒ«ãƒ‰æ‰‹ã«å…¥ã‚ŒãŸï¼");
            map.data[ny][nx] = 19;
        }
        if (tile === 17) {
            hero.hasKey = true;
            showAlert("å®ç®±ã‹ã‚‰ã€å¤ã„éµã€ã‚’è¦‹ã¤ã‘ãŸï¼");
            map.data[ny][nx] = 19;
        }
        if (tile === 15) {
            const npc = map.npcs.find(n => n.x === nx && n.y === ny);
            if (npc) showAlert(npc.msg);
        }
        if (tile === 8) showShop(); 
        if (tile === 4) triggerBossEvent();
        if (tile === 23) showAlert("å¹½éœŠ:ã€Œã“ã“ã¯ã‹ã¤ã¦ã®æ‘â€¦ã™ã¹ã¦ã¯é­”ç‹ã«å¥ªã‚ã‚ŒãŸâ€¦ã€");
        if (tile === 24) startMomoBattle();

        if ((tile === 10 || tile === 11 || tile === 20 || tile === 21 || tile === 22) && Math.random() < 0.15) {
            startBattle();
        }
    }
    afterMove();
}

function afterMove() {
    updateNPCs();
    drawMap(); 
    updateStatus();
}

function updateNPCs() {
    const map = worldMaps[hero.currentArea];
    if (map.npcs) {
        map.npcs.forEach(npc => {
            const directions = [[0,1], [0,-1], [1,0], [-1,0]];
            const dir = directions[Math.floor(Math.random() * directions.length)];
            const tx = npc.x + dir[0];
            const ty = npc.y + dir[1];
            if (tx >= 0 && tx <= 9 && ty >= 0 && ty <= 9 && map.data[ty][tx] === 0 && !(tx === hero.x && ty === hero.y)) {
                npc.x = tx;
                npc.y = ty;
            }
        });
    }
}

function addAlly(type) {
    const ally = allyData[type];
    if (!party.find(m => m.name === ally.name)) {
        party.push({ ...ally });
        worldMaps[hero.currentArea].data[hero.y][hero.x] = 0; 
        drawMap();
        updateStatus();
        showAlert(`${ally.name}:ã€Œ${ally.msg}ã€\n\n${ally.name}ãŒä»²é–“ã«åŠ ã‚ã£ãŸï¼`);
    }
}

/* --- ã‚·ãƒŠãƒªã‚ªã‚¤ãƒ™ãƒ³ãƒˆ --- */
function startPrologue() {
    const textElem = document.getElementById('prologue-text');
    if (prologueStep === 0) {
        let name = prompt("ãŠä¸»ã®åå‰ã‚’æ•™ãˆã¦ãã‚Œï¼ˆã‚«ã‚¿ã‚«ãƒŠ4æ–‡å­—ä»¥å†…ï¼‰", "ãƒ¦ã‚¦ã‚·ãƒ£");
        if (!name) name = "ãƒ¦ã‚¦ã‚·ãƒ£";
        hero.name = name.substring(0, 4);
        textElem.innerText = `ç‹æ§˜ï¼šã€Œãã†ã˜ã‚ƒã£ãŸã€${hero.name}ã‚ˆã€‚é ¼ã¿ãŒã‚ã‚‹ã€‚ã€`;
        prologueStep++;
    } else if (prologueStep === 1) {
        textElem.innerText = "ç‹æ§˜ï¼šã€Œæœ€è¿‘ã€è¡—ã®å·ã®æµã‚ŒãŒæ‚ªããªã£ã¦ãŠã‚‹ã®ã˜ã‚ƒã€‚ã€";
        prologueStep++;
    } else if (prologueStep === 2) {
        textElem.innerText = "ç‹æ§˜ï¼šã€Œä½•è€…ã‹ãŒå·ä¸Šã§æ‚ªã•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã‚“ã€‚ã€";
        prologueStep++;
    } else if (prologueStep === 3) {
        textElem.innerText = `ç‹æ§˜ï¼šã€Œ${hero.name}ã‚ˆã€å·ä¸Šã‚’èª¿ã¹ã¦ãã¦ã¯ãã‚Œã¾ã„ã‹ï¼Ÿã€`;
        prologueStep++;
    } else {
        showScreen('main-screen');
        drawMap();
        updateStatus();
        showAlert("ç‹æ§˜ã«é ¼ã¾ã‚Œã€å†’é™ºãŒå§‹ã¾ã£ãŸï¼");
    }
}

function triggerBossEvent() {
    const choice = confirm("æ°´æºã«é­”ç‹ãŒã„ã¾ã™ã€‚æˆ¦ã„ã¾ã™ã‹ï¼Ÿ");
    if (choice) {
        startBossBattle();
    } else {
        const joinChoice = confirm("ç§ãŒå…ƒç‹æ§˜ã ã€‚æ°´æºã®å²©ã‚’ã©ã‹ã™ã®ã‚’æ‰‹ä¼ã£ã¦ãã‚Œã‚“ã‹ï¼Ÿ");
        if (joinChoice) {
            trueKingMet = true;
            showAlert("ã‚ã‚ŠãŒã¨ã†ã€‚è¡—ã®ç‹ã¯å½ç‰©ã ã€‚æ‡²ã‚‰ã—ã‚ã¦ãã‚Œã€‚");
        } else {
            startBossBattle();
        }
    }
}

function startNiseousamaBattle() {
    showAlert("ã‚ªã‚¦ã‚µãƒãƒ‹ã‚¢:ã€Œãƒãƒ¬ãŸã‹ã€‚é‚ªé­”è€…ã¯æ¶ˆãˆã‚ˆï¼ï¼ï¼ï¼ã€");
    isBattle = true;
    isBattleEnding = false;
    currentEnemy = { 
        name: "ã‚ªã‚¦ã‚µãƒãƒ‹ã‚¢", 
        hp: 1200, 
        atk: 70, 
        exp: 0, 
        gold: 0, 
        img: 'ğŸ¤´' 
    };
    initBattle();
}

function startMomoBattle() {
    showAlert("æ¡ƒä»™äºº:ã€Œã‹ã¤ã¦ã®æ‘ã‚’è’ã‚‰ã™ã®ã¯ãŠä¸»ã‹ï¼Ÿ è©¦ç·´ã‚’ä¸ãˆã‚ˆã†ï¼ã€");
    isBattle = true;
    isBattleEnding = false;
    currentEnemy = { 
        name: "æ¡ƒä»™äºº", 
        hp: 800, 
        atk: 45, 
        exp: 1000, 
        gold: 500, 
        img: 'ğŸ‘' 
    };
    initBattle();
}

/* --- æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ  --- */
function startBattle() {
    isBattle = true;
    isBattleEnding = false;
    const areaMonsters = monsterTable[hero.currentArea] || monsterTable["green_field"];
    const randomIndex = Math.floor(Math.random() * areaMonsters.length);
    currentEnemy = { ...areaMonsters[randomIndex] };
    initBattle();
}

function startBossBattle() {
    isBattle = true;
    isBattleEnding = false;
    currentEnemy = { name: "é­”ç‹", hp: 1000, atk: 60, exp: 0, gold: 0, img: "ğŸ‘¹" };
    initBattle();
}

function initBattle() {
    canAttack = true;
    document.getElementById('monster-name').innerText = currentEnemy.name;
    document.getElementById('monster-sprite').innerHTML = currentEnemy.img;
    document.getElementById('battle-log').innerText = `${currentEnemy.name}ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`;
    updateBattleStatus();
    showScreen('battle-screen');
}

function updateBattleStatus() {
    const area = document.getElementById('party-status-area');
    area.innerHTML = '<div style="border-bottom: 1px solid #fff; margin-bottom: 5px;">NAME HP</div>';
    party.forEach(m => {
        const displayHp = m.hp > 0 ? m.hp : 0;
        area.innerHTML += `<div class="status-row" style="display:flex; justify-content:space-between;"><span>${m.name}</span><span>${displayHp}/${m.maxHp}</span></div>`;
    });
}

function heroTurn(action) {
    if (!canAttack) return;
    canAttack = false;
    performAttack(hero);

    if (currentEnemy.hp > 0) {
        setTimeout(partyTurn, 800);
    } else {
        setTimeout(winBattle, 800);
    }
}

function partyTurn() {
    let index = 1;
    function nextAlly() {
        if (currentEnemy.hp <= 0) { winBattle(); return; }
        if (index < party.length) {
            const member = party[index];
            if (member.hp > 0) { performAttack(member); index++; setTimeout(nextAlly, 800); }
            else { index++; nextAlly(); }
        } else {
            if (currentEnemy.hp > 0) setTimeout(enemyTurn, 800);
            else winBattle();
        }
    }
    nextAlly();
}

function performAttack(attacker) {
    let dmg = attacker.atk + Math.floor(Math.random() * 10);
    currentEnemy.hp -= dmg;
    document.getElementById('battle-log').innerText = `${attacker.name}ã®æ”»æ’ƒï¼${currentEnemy.name}ã«${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
    updateBattleStatus();
}

function enemyTurn() {
    const aliveMembers = party.filter(m => m.hp > 0);
    if (aliveMembers.length === 0) return; 
    const target = aliveMembers[Math.floor(Math.random() * aliveMembers.length)];
    let dmg = Math.max(1, currentEnemy.atk - 5);
    target.hp -= dmg;
    document.getElementById('battle-log').innerText = `${currentEnemy.name}ã®æ”»æ’ƒï¼${target.name}ã¯${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
    updateBattleStatus();

    if (hero.hp <= 0) { 
        showAlert("å‹‡è€…ãŒåŠ›å°½ããŸ..."); 
        setTimeout(() => location.reload(), 2000); 
    } else { 
        setTimeout(() => { 
            canAttack = true; 
            document.getElementById('battle-log').innerText = "ã‚³ãƒãƒ³ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ (Aãƒœã‚¿ãƒ³)"; 
        }, 800); 
    }
}

function winBattle() {
    isBattleEnding = true;
    document.getElementById('battle-log').innerText = `${currentEnemy.name}ã‚’å€’ã—ãŸï¼ (Aãƒœã‚¿ãƒ³ã§é€²ã‚€)`;
}

function confirmBattleResult() {
    isBattle = false;
    isBattleEnding = false;
    if (currentEnemy.name === "é­”ç‹") {
        document.getElementById('ending-msg').innerText = `ã“ã†ã—ã¦è¡—ã®å·ã¯ç©ã‚„ã‹ãªæµã‚Œã‚’å–ã‚Šæˆ»ã—ãŸã€‚`;
        showScreen('ending-screen');
    } else if (currentEnemy.name === "ã‚ªã‚¦ã‚µãƒãƒ‹ã‚¢") {
        document.getElementById('ending-title').innerText = "TRUE ENDING";
        document.getElementById('ending-msg').innerText = `å½ã®ç‹ã‚’è¿½ã„å‡ºã—ã€æœ¬ç‰©ã®ç‹ãŒè¡—ã«æˆ»ã£ãŸï¼`;
        showScreen('ending-screen');
    } else {
        if (currentEnemy.name === "æ¡ƒä»™äºº") {
            showAlert("æ¡ƒä»™äºº:ã€Œè¦‹äº‹ã ã€‚ãŠä¸»ã«çœŸã®åŠ›ã‚’æˆã‘ã‚ˆã†ã€‚ã€\nå‹‡è€…ã®æ”»æ’ƒåŠ›ãŒå¤§å¹…ã«ã‚¢ãƒƒãƒ—ã—ãŸï¼");
            hero.atk += 30;
            worldMaps["ruined_village"].data[3][6] = 22; // æ¡ƒä»™äººã‚’åºŠã«æˆ»ã™
        }
        hero.exp += currentEnemy.exp;
        hero.gold += (currentEnemy.gold || 0); 
        const map = worldMaps[hero.currentArea];
        if (map.data[hero.y][hero.x] === 2) map.data[hero.y][hero.x] = 22;
        showScreen('main-screen'); 
        drawMap(); 
        updateStatus();
        checkLevelUp();
    }
}

/* --- ã‚·ã‚¹ãƒ†ãƒ é–¢æ•° --- */
function checkLevelUp() { 
    if (hero.exp >= hero.lv * 100) { 
        hero.lv++; 
        hero.atk += 10; 
        hero.maxHp += 20; 
        hero.hp = hero.maxHp; 
        showAlert(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ LV ${hero.lv}\næ”»æ’ƒåŠ›ã¨HPãŒä¸ŠãŒã£ãŸï¼`); 
    } 
}

function rest() { 
    hero.hp = hero.maxHp; 
    hero.mp = hero.maxMp; 
    updateStatus(); 
    showAlert("å®¿å±‹ã§ä¼‘ã‚“ã§å…¨å¿«ã—ãŸï¼"); 
}

function updateStatus() { 
    document.getElementById('st-hp').innerText = `HP: ${hero.hp}/${hero.maxHp} | Gold: ${hero.gold}G | éµ: ${hero.hasKey ? 'æŒ' : 'ç„¡'}`; 
    document.getElementById('st-party').innerText = `ä¸€è¡Œ: [${hero.name}] ` + party.slice(1).map(m => m.name).join(", "); 
}

function showScreen(id) { 
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
}

function showAlert(text) { 
    document.getElementById('dialog-message').innerText = text; 
    document.getElementById('custom-dialog-overlay').style.display = 'flex'; 
}

function closeCustomDialog() { 
    document.getElementById('custom-dialog-overlay').style.display = 'none'; 
}

function showShop() {
    let msg = "æ­¦å™¨å±‹ (ç•ªå·å…¥åŠ›):\n";
    shopItems.forEach((item, index) => { msg += `${index}: ${item.name} (${item.price}G)\n`; });
    const choice = prompt(msg);
    if (choice !== null && shopItems[choice]) {
        const item = shopItems[choice];
        if (hero.gold >= item.price) { 
            hero.gold -= item.price; 
            hero.atk += item.atk; 
            showAlert(`${item.name}ã‚’è³¼å…¥ï¼`); 
            updateStatus(); 
        } else { showAlert("ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); }
    }
}

document.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
</script>
</body>
</html>
